```{r, echo=FALSE,results='hide', message=FALSE}
library(remake)
create_bindings()

source("scripts/summary_dataframes.R")
source("scripts/functions.R")
```
#Growth data, general patterns
- proportion of maxH matters more for some species than others. 
  1. The 4 "canopy" species all tend to have high correlations between "prop maxH" and growth and reproductive investment (both relative and absolute)  
  2. The lower-growing species are more variable, with "prop maxH mattering more for some than others"  

- For almost all species there is a strong negative relationship between RGR and RA - indeed, more reproduction = less growth  
  1. Meanwhile there is the strong positive relationship between growth investment and reproductive investment, because bigger plants grow and reproduce more.  
  2. It is good to have a big enough data set to capture both trends - and to capture them consistently across many species

- Many plants have a clear upturn in RA and corresponding downturn in RGR at a specific prop maxH  
  1. e.g. see EPMI for distinct pattern


#Comparing growth between different measures and across age

###Weight vs. height
- No surprises here , but need to fit proper lines to the data
- Plants asymptote in weight as they reach their maximum height. This is true for all species, although some species, like BOLE and GRBU, have a much messier scatter than others  
- The follow on of course is to look at growth measures vs. height   
- NOTE: All heights have been scaled 0-1 based on the maximum height of each species across all of the sites. This has no effect on within species analyses, but lets data from all species to be plotted together  


```{r, echo=FALSE, message=FALSE}
plot((FinalWeight~PropH), SummaryInd, col=col.spp[as.factor(species)],pch=16,log="y")
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "FinalWeight"
xvar <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="y",
                    main=spp, xlab=xvar, ylab=yvar)
  abline(lmfits[[spp]])
}
```

###Growth Investment versus proportion max H
- This turns out to be one of the most interesting sets of graphs  
- For the canopy species, PELA, HATE, PEPU, BAER, investment in growth plateaus (i.e. growth relative to size decreases) at ~40% maxH  
- For the shorter and shorter-lived species there is much less of a relationship, or a complete lack of relationship (i.e. BOLE, PHPH)  
- Quite interesting, there is a distinctly negative relationship for GRBU; its absolute growth investment actually declines as it increases in size  
- For many of the species with a good relationship, it seems that there are two breakpoints in the curve - wondering what these mean with respect to reproductive onset and RA  
 
```{r, echo=FALSE,message=FALSE,fig.width=14, fig.height=7}
par(mfrow=c(1,2), cex=1, omi=c(.1,0.3,.5,0.2), mai=c(1.1,1,.1,0.2))
plot((GrowthInv~PropH), SummaryInd, log="y", col=col.spp[as.factor(species)],pch=16)
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(GrowthInv~PropH, SummaryInd, log="y", col=col.age[as.factor(age)],pch=16)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

yvar <- "GrowthInv"
xvar <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results
```

```{r, echo=FALSE,message=FALSE, fig.width=7, fig.height=7}
par(mfrow=c(1,1), cex=1, omi=c(.1,.1,.1,.1), mai=c(1.1,1.1,.1,0.2)) 
for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, log="y",
                    main=spp, xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

###Proportion max H by RGR
- Ignoring a few outliers, RGR declines with increasing height is 12 species  
- Only in HEPU and PILI is there no significant trend  
- The species with a poorer correlation are mostly shorter ones that are presumably often broken off   
- These are continued ways to look at the question of how important is height (relative to the species maxH) in understanding its growth and reproduction  

```{r, echo=FALSE, message=FALSE}
yvar <- "RGR"
xvar <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm((x[[yvar]]) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results
```

###Growth Investment versus weight   
- showing that slope continues to be 1:1, but intercept decreases with time because more standing biomass
```{r, echo=FALSE, message=FALSE}
plot((GrowthInv~FinalWeight), SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
abline(0,1,lwd=2)
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(GrowthInv~FinalWeight, SummaryInd, log="xy", col=col.age[as.factor(age)],pch=16)
abline(0,1,lwd=2)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")
```

#Comparing growth of whole plant vs. leader

###Correlations between different growth measures
- Increased cross-sectional area of a leader and the entire plant are fairly correlated and uneffected by age (once not baby)  

TO DO: species should be a random effect for these stats- I want to know the effect of age on the relationship once the effect of species has been accounted for  

```{r, echo=FALSE,message=FALSE}
plot(change_shoot_area~change_basal_area,SummaryInd, log="xy",col=col.age[as.factor(age)], pch=16, cex=.8,xlab="change in basal stem area",ylab="change in shoot area")
legend("bottomright",col=col.age, labels.age, pch=16, cex=1,bty="n")
mod <- lm(change_shoot_area~change_basal_area*age*species,SummaryInd)
anova(mod)
``` 

###Shifts in leafiness with age  
- Individual shoots looked decidedly "less leafy" in many older plants  
- This led me to wonder how leaf lifespan - or some other variable - was shifting with age   
- The number of leaves along a leader is overall uneffected by age  
- However, looking at individual species: BOLE, GRBU, GRSP, HEPU, PILI, PUTU have declining leaf counts along a shoot with age  
- And PELA, PEPU show a significant increase in leaf counts along a single shoot with age 

```{r, echo=FALSE,message=FALSE}
plot(lvs_end_total~age,SummaryInd,log="xy", xlab="age",ylab="final leaf count along shoot",col=col.spp[as.factor(species)])
legend("bottomright",col=col.spp, labels.spp, pch=16, cex=1,bty="n")

yvar <- "lvs_end_total"
xvar <- "age"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm((x[[yvar]]) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, log="x",
                    main=spp, xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

###Leaf weight (relative to total weight) also declines with age  
- These numbers are currently incomplete - waiting for full set of "leaf weight" numbers to finalize this  

```{r, echo=FALSE,message=FALSE}
plot(total_leaf_weight~FinalWeight,SummaryInd, log="xy",col=col.age[as.factor(age)], pch=16, cex=0.8)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1, bty="n")

plot(total_leaf_weight~FinalWeight,SummaryInd, log="xy",col=col.spp[as.factor(species)], pch=16, cex=0.8)
legend("bottomright",col=col.spp, labels.spp, pch=16, cex=.8, bty="n")
```

###Shifts in shoot extension with age
- The decrease in leaf number along a shoot is largely caused by declining shoot extension, not shifts in leaf lifespan  
- BAER, BOLE, EPMI, GRBU, GRSP, HATE, HEPU, PHPH, PILI, and PUTU all show significant declines in shoot extension with age  
- For many of these species, the shift is between the "sapling" and "adult" stages - i.e. when they begin reproducing  
- PELA stands out by showing increasing shoot extension with age - because it grows so slowly in the beginning  

```{r, echo=FALSE,message=FALSE}
plot(new_length~age,SummaryInd,log="xy", xlab="age",ylab="shoot extension (mm)",col=col.spp[as.factor(species)])
legend(12,200,col=col.spp, labels.spp, pch=16, cex=.8,bty="n")

yvar <- "new_length"
xvar <- "age"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm((x[[yvar]]) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, log="x",
                    main=spp, xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```
###Diameter increase in shoots vs. whole plant
- The slope of the relationship lessens with age  
- There is quite a bit of noise in the relationship  
- However, in many cases, older plants show less of a change in shoot diameter for a given change in basal diameter; the opposite pattern as is predicted if ever fewer shoots are sustaining growth  
- Instead, each shoot matters ever less to the overall increase in basal area in larger plants
- NOTE: Plots not correct right now - wrong number of points in some and definitely wrong coloring by age
```{r, echo=FALSE,message=FALSE}
plot((change_shoot_diam/100) ~ change_basal_diam,data=subset(SummaryInd, age>1.4), log="xy",col=col.spp[as.factor(species)], pch=16)
abline(0,1)

mod <- lm (change_shoot_diam ~ change_basal_diam*age,data=subset(SummaryInd, age>1.4))
summary(mod)
anova(mod)

plot((change_shoot_diam/100) ~ change_basal_diam,data=subset(SummaryInd, age>1.4), log="xy",col=col.age2[as.factor(age)], pch=16)
abline(0,1)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1, bty="n")

plot((change_shoot_area/10000) ~ FinalBasalDiamAv,data=subset(SummaryInd), log="xy",col=col.spp[as.factor(species)], pch=16,ylim=c(0.01,500),cex=.7)
points((change_basal_area) ~ FinalBasalDiamAv,data=subset(SummaryInd), log="xy",col=col.spp[as.factor(species)], pch=1)

plot((change_shoot_area/10000) ~ FinalBasalDiamAv,data=subset(SummaryInd), log="xy",col=col.age[as.factor(age)], pch=16,ylim=c(0.01,500),cex=.7)
points((change_basal_area) ~ FinalBasalDiamAv,data=subset(SummaryInd), log="xy",col=col.age[as.factor(age)], pch=1)

yvar <- "change_shoot_diam"
xvar <- "change_basal_diam"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, log="xy", col=col.age[as.factor(SummaryInd$age)],
                    main=spp, xlab=xvar, ylab=yvar)
  legend("bottomright",col=col.age, labels.age, pch=16, cex=1, bty="n")
}
```

#Comparing growth rates of species with different trait values

### Species with larger seeds have higher growth rates  
- The same basic relationship exists across all ages, so combined all data here  
```{r, echo=FALSE,message=FALSE}
plot(GrowthInv_mean ~ seed_size,data=subset(SummarySppAge,age>.5),log="xy",col=col.age[as.factor(age)],pch=16,cex=1,xlab="seed size (mg)",ylab="growth investment (mg per year)",main="Effect of seed size on growth rates")
legend("topleft",col=col.age, labels.age, pch=16, cex=1,bty="n")
text(GrowthInv_mean ~ seed_size, data=subset(SummarySppAge,age==9), labels=species, pos=2, offset=-2.4, cex=0.9,col="blue")
```

### Species with greater maximum height have higher growth rates
- For younger plants there is no relationship with *SPECIES* overall maximum H  
- There is a positive correlation with the maximum height the species reaches at a given age -i.e. fast growing young plants are tall when young.  
```{r, echo=FALSE,message=FALSE}
plot(GrowthInv_mean ~ maxH_spp,data=subset(SummarySppAge,age<3),log="xy",col=col.age[as.factor(age)],pch=16,cex=1.1,xlab="maximum height (mm)",ylab="growth investment (mg per year)",xlim=c(500,3200),main="Relationship between growth rates on maximum H")
legend("bottomright",col=col.age, labels.age, pch=16, cex=1,bty="n")
text(GrowthInv_mean ~ maxH_spp, data=subset(SummarySppAge,age==2.4), labels=species, pos=2, offset=-2.4, cex=0.9,col="blue")

plot(GrowthInv_mean ~ maxH_spp,data=subset(SummarySppAge,age>3),log="xy",col=col.age3[as.factor(age)],pch=16,cex=1.1,xlab="maximum height (mm)",ylab="growth investment (mg per year)",xlim=c(500,3200),main="Relationship between growth rates on maximum H")
legend("bottomright",col=col.age, labels.age, pch=16, cex=1,bty="n")
text(GrowthInv_mean ~ maxH_spp, data=subset(SummarySppAge,age==9), labels=species, pos=2, offset=-2.4, cex=0.9,col="blue")
```

### Species with higher wood density have lower growth rates  
- Adult plants strongly show this pattern
- However there is no relationship in younger plants  
```{r, echo=FALSE,message=FALSE}
plot(GrowthInv_mean ~ WD_mean,data=subset(SummarySppAge,age>3),log="xy",col=col.age3[as.factor(age)],pch=16,cex=1,xlab="wood density",ylab="growth investment (mg per year)",xlim=c(0.57,0.9),main="Relationship between wood density and growth rates")
text(GrowthInv_mean ~ WD_mean, data=subset(SummarySppAge,age==5), labels=species, pos=2, offset=-2.4, cex=0.9,col="blue")
legend("bottomleft",col=col.age, labels.age, pch=16, cex=1, bty="n")

plot(GrowthInv_mean ~ WD_mean,data=subset(SummarySppAge,age<3),log="xy",col=col.age[as.factor(age)],pch=16,cex=1,xlab="wood density",ylab="growth investment (mg per year)",xlim=c(0.57,0.9),main="Relationship between wood density and growth rates")
text(GrowthInv_mean ~ WD_mean, data=subset(SummarySppAge,age==2.4), labels=species, pos=2, offset=-2.4, cex=0.9,col="blue")
legend("bottomleft",col=col.age, labels.age, pch=16, cex=1, bty="n")
```

### Species with higher LMA have higher growth rates  
- This pattern is true for adult plants  
- But there is no relationship in seedlings (age=1.4) or saplings (age=2.4)  
- This is not predicted by Daniel's model or Anais' review; re-run with RGR
```{r, echo=FALSE,message=FALSE}
plot(GrowthInv_mean ~ LMA_mean,data=subset(SummarySppAge,age==1.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=1.2,xlab="LMA",ylab="growth investment (mg per year)",main="Seedlings")
text(GrowthInv_mean ~ LMA_mean, data=subset(SummarySppAge,age==1.4), labels=species, pos=1, offset=-1.1, cex=0.9,col="blue")
mod <- lm(GrowthInv_mean ~ LMA_mean, data=subset(SummarySppAge,age==1.4))
summary(mod)

plot(GrowthInv_mean ~ LMA_mean,data=subset(SummarySppAge,age==2.4),log="xy",col="pink",pch=16,cex=1.2,xlab="LMA",ylab="growth investment (mg per year)",main="Saplings")
text(GrowthInv_mean ~ LMA_mean, data=subset(SummarySppAge,age==2.4), labels=species, pos=1, offset=-1.1, cex=0.9,col="blue")
mod <- lm(GrowthInv_mean ~ LMA_mean, data=subset(SummarySppAge,age==2.4))
summary(mod)

plot(GrowthInv_mean ~ LMA_mean,data=subset(SummarySppAge,age>3),log="xy",col=col.age3[as.factor(age)],pch=16,cex=1.2,xlab="LMA",ylab="growth investment (mg per year)",main="Adults")
text(GrowthInv_mean ~ LMA_mean, data=subset(SummarySppAge,age>3), labels=species, pos=1, offset=-1.1, cex=0.6,col="blue")
legend("bottomright",col=col.age,labels.age,pch=16, bty="n")
mod <- lm(GrowthInv_mean ~ LMA_mean, data=subset(SummarySppAge,age>3))
summary(mod)
```

###Looking at LMA relative to RGR
- There are no significant relationships at any age when RGR is used instead of actual growth investment 
```{r, echo=FALSE,message=FALSE}
plot(RGR_mean ~ LMA_mean,data=subset(SummarySppAge,age==1.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=1.2,xlab="LMA",ylab="RGR=",main="Seedlings")
text(RGR_mean ~ LMA_mean, data=subset(SummarySppAge,age==1.4), labels=species, pos=1, offset=-1.1, cex=0.9,col="blue")
mod <- lm(GrowthInv_mean ~ LMA_mean, data=subset(SummarySppAge,age==1.4))
summary(mod)

plot(RGR_mean ~ LMA_mean,data=subset(SummarySppAge,age==2.4),log="xy",col="pink",pch=16,cex=1.2,xlab="LMA",ylab="RGR",main="Saplings")
text(RGR_mean ~ LMA_mean, data=subset(SummarySppAge,age==2.4), labels=species, pos=1, offset=-1.1, cex=0.9,col="blue")
mod <- lm(RGR_mean ~ LMA_mean, data=subset(SummarySppAge,age==2.4))
summary(mod)

plot(RGR_mean ~ LMA_mean,data=subset(SummarySppAge,age>3),log="xy",col=col.age3[as.factor(age)],pch=16,cex=1.2,xlab="LMA",ylab="RGR",main="Adults")
text(RGR_mean ~ LMA_mean, data=subset(SummarySppAge,age>3), labels=species, pos=1, offset=-1.1, cex=0.6,col="blue")
legend("bottomright",col=col.age,labels.age,pch=16, bty="n")
mod <- lm(RGR_mean ~ LMA_mean, data=subset(SummarySppAge,age>3))
summary(mod)
```

###Leaf lifespan vs growth investment
- There is no relationship between leaf lifespan and growth investment for any age group
- And just barely a significant relationship between RGR and leaflifespan for adult plants
```{r, echo=FALSE,message=FALSE}
plot(GrowthInv ~ LL_death,data=subset(SummaryInd,age==1.4),log="xy",col=col.spp[as.factor(species)],pch=16,cex=1.2,xlab="leaf lifespan",ylab="growth investment (mg per year)",main="Seedlings")
legend(4.5,1600,col=col.spp,labels.spp,pch=16, bty="n",cex=.8)
mod <- lm(GrowthInv ~ LL_death, data=subset(SummaryInd,age==1.4))
summary(mod)

plot(GrowthInv ~ LL_death,data=subset(SummaryInd,age==2.4),log="xy",col=col.spp[as.factor(species)],pch=16,cex=1.2,xlab="leaf lifespan",ylab="growth investment (mg per year)",main="Saplings")
legend("bottomright",col=col.spp,labels.spp,pch=16, bty="n",cex=.8)
mod <- lm(GrowthInv ~ LL_death, data=subset(SummaryInd,age==2.4))
summary(mod)

plot(GrowthInv ~ LL_death,data=subset(SummaryInd,age>3&LL_death<10),log="xy",col=col.age3[as.factor(age)],pch=16,cex=1.2,xlab="leaf lifespan",ylab="growth investment (mg per year)",main="Adults")
legend("bottomright",col=col.age,labels.age,pch=16, bty="n")
mod <- lm(GrowthInv ~ LL_death*species, data=subset(SummaryInd,age>3))
anova(mod)
```

```{r, echo=FALSE,message=FALSE}
plot(RGR ~ LL_death,data=subset(SummaryInd,age==1.4),log="xy",col=col.spp[as.factor(species)],pch=16,cex=1.2,xlab="leaf lifespan",ylab="RGR",main="Seedlings")
legend(4.5,1600,col=col.spp,labels.spp,pch=16, bty="n",cex=.8)
mod <- lm(RGR ~ LL_death, data=subset(SummaryInd,age==1.4))
summary(mod)

plot(RGR ~ LL_death,data=subset(SummaryInd,age==2.4),log="xy",col=col.spp[as.factor(species)],pch=16,cex=1.2,xlab="leaf lifespan",ylab="RGR",main="Saplings")
legend("bottomright",col=col.spp,labels.spp,pch=16, bty="n",cex=.8)
mod <- lm(RGR ~ LL_death, data=subset(SummaryInd,age==2.4))
summary(mod)

plot(RGR ~ LL_death,data=subset(SummaryInd,age>3&LL_death<10&RGR>0.04),log="xy",col=col.age3[as.factor(age)],pch=16,cex=1.2,xlab="leaf lifespan",ylab="RGR",main="Adults")
legend("bottomright",col=col.age,labels.age,pch=16, bty="n")
mod <- lm(RGR ~ LL_death*species, data=subset(SummaryInd,age>3&LL_death<10&RGR>0.04))
anova(mod)
```