```{r, echo=FALSE,results='hide', message=FALSE}
library(remake)
create_bindings()

source("scripts/summary_dataframes.R")
```
#RV curves and RA schedules, general patterns
- RA best plotted against height for many species - much clearer pattern than against weight or age - this seems to support Daniel's suspicion that deadwood shouldn't be included in the "weight" of the plant
- A number of species show an abrupt decrease in RGR (or tapering of growth investment) at the height where reproduction begins. This is evidence of the growth-reproduction trade-off
- RV curves are mostly quite pretty, but not necessarily very meaningful

#Generic functions for most plotting below
```{r, echo=FALSE, message=FALSE}
plot_yvar_vs_xvar <- function(data, yvar = "y", xvar = "x", ...) {
  Y <- data[[yvar]]
  X <- data[[xvar]]
  plot(Y ~ X, data=data,  cex.axis=.8, las=1, pch=16, ...)
}

summarise_fit <- function(x) {
  data.frame(
    select(glance(x), r.squared, p.value),
    n= length(resid(x)),
    a = coef(x)[1],
    b = coef(x)[2]
  )
}

summarise_all_fits <- function(x) {
  tmp <- lapply(x, summarise_fit) %>%
    bind_rows
  data.frame(species=names(x), tmp)
}

summarise_fit_2var <- function(x) {
  data.frame(
    select(glance(x), r.squared, p.value),
    n= length(resid(x)),
    intercept = coef(x)[1],
    coef_var1 = coef(x)[2],
    coef_var2 = coef(x)[3],
    coef_var1var2 = coef(x)[4],
    SS_var1 = anova(x)[1,2],
    SS_var2 = anova(x)[2,2],
    SS_var1var2 =anova(x)[3,2]
      )
}

summarise_all_fits_2var <- function(x) {
  tmp <- lapply(x, summarise_fit_2var) %>%
    bind_rows
  data.frame(species=names(x), tmp)
}
```


#RV curves
###Classic RV curves - reproductive investment versus weight
- These are mostly reasonably nice - of course need to fit quadratic curve to these and haven't figured out how to do it correctly  
- The plot that includes all species shows that *once* a given species has ramped up reproduction, the log-log plot of reproductive investment vs final weight is nearly linear across all species; in other words, to first order, all species allocate the same amount to reproduction relative to their weight.
- However, it is important to note that species early in their reproductive trajectory do not follow this pattern
```{r, echo=FALSE,message=FALSE}
plot(ReproInv~total_weight, SummaryInd, log="xy",col=col.spp[as.factor(species)],pch=16)
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(ReproInv~total_weight, SummaryInd, log="xy", col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

plot((1+ReproInv_mean)~total_weight_mean,SummarySppAge,log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "ReproInv"
xvar <- "total_weight"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]+1) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

###RV curves (by age)
```{r, echo=FALSE,message=FALSE}
plot(ReproInv~age, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend(15,5000,legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot((1+ReproInv_mean)~age,SummarySppAge,log="xy", col=col.spp[as.factor(species)],pch=16)
legend(15,5000,legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "ReproInv"
xvar <- "age"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]+1) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

###RV curves (by proportion max H)
- In a sense, by using proportion max H, these figures are showing the proportion of total growth the plant undergoes before starting reproduction
- You could also plot against "PropMaxWeight", the proportion of the heaviest individual of that species. The two measures look "best" for different species
```{r, echo=FALSE,message=FALSE}
plot((PropMaxRepro+.1)~(PropH), SummaryInd, log="y",col=col.spp[as.factor(species)],pch=16,xlim=c(4e-03,1))
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "ReproInv"
xvar <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]+1) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="y", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

#RA schedules (vs. propH)  
- these curves are particularly good for a number of species such as EPMI, COER, PELA  
- they also show that for PILI that among individuals that reproduce, the "potential" RA decreases with increasing propH  
- when all data points are included, all species except PEPU, PHPH, and PULU show increasing RA with increasing height  
- when RA =0 is excluded, the following species still have a significant positive correlation: BOLE, COER, EPMI, GRBU, GRSP, HATE. LEES and PELA have a p-value between 0.05-0.10   
- PEPU has a negative correlation - matches Mark's suggestion that it is "hanging on"  

 NOTE: Again, a linear line is not necessarily the most appropriate 

```{r, echo=FALSE, message=FALSE}
plot((RA~PropH), SummaryInd, col=col.spp[as.factor(species)],pch=16)
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA~PropH, SummaryInd, col=col.age[as.factor(age)],pch=16)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "PropH"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(asin(sqrt(x[[yvar]])) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,
                    main=spp, xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

#RA schedules (by age)
```{r, echo=FALSE,message=FALSE}
plot(RA~age, SummaryInd, log="x", col=col.spp[as.factor(species)],pch=16)
legend(15,.9,legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA_mean~age,SummarySppAge,log="x", col=col.spp[as.factor(species)],pch=16)
legend(15,.5,legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "age"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm((x[[yvar]]) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="x", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```


#RA schedules (by size)
1. These plots have always been unsatisfying - with few exceptions (PULU, PEPU, LEES) plots against height are stronger. And both PILI and PEPU have very low R^2 by either method  
2. If Only individuals with RA>0 are included only COER, EPMI, GRBU, HATE and LEES still have a significant positive correlation - for the remaining species correlation only exists because of small, non-reproductive plants having a strong effect on the curve  

```{r, echo=FALSE,message=FALSE}
plot(RA~total_weight, SummaryInd, log="x", col=col.spp[as.factor(species)],pch=16)
legend("topright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA_mean~total_weight_mean,SummarySppAge,log="x", col=col.spp[as.factor(species)],pch=16)
legend("topright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "total_weight"

data <- subset(SummaryInd)
data <- split(data, data$species)

lmfits <- lapply(data, function(x) lm((x[[yvar]]) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="x", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

#Reproductive Investment by Growth Investment
Overall, these are not a strong set of results, but HATE shows a very strong relationship that shows reproductive investment (not growth investment) asymptoting
Interestingly, PHPH, which is generally a complete scatter plot, has one of the strongest correlations between these variables, indicating that indeed most measures of "size" for this multi-stemmed plant aren't very meaningful and it should be analyzed differently.

Note that the analyses are just being done on reproducing individuals at the moment.
```{r, echo=FALSE,message=FALSE}
plot((1+ReproInv)~GrowthInv, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot((1+ReproInv)~GrowthInv, SummaryInd, log="xy", col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

plot((1+ReproInv_mean)~GrowthInv_mean,SummarySppAge,log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "GrowthInv"
xvar <- "ReproInv"

data <- subset(SummaryInd,RA>0)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]+1) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

#RA by Growth Investment
Across all species, high RA = low growth investment. This pattern exists mostly because of shifts in species from high reproducers to high growers - i.e. BOLE in one corner, and BAER & HATE in another.
For analyses within individual species
```{r, echo=FALSE,message=FALSE}
plot(RA~GrowthInv, SummaryInd, log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA~GrowthInv, SummaryInd, log="x", col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

plot(RA_mean~GrowthInv_mean,SummarySppAge,log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(GrowthInv~RA, data=subset(SummaryInd,RA>0), log="y", col=col.spp[as.factor(species)],pch=16)
legend("topright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")
mod <- lm(log(GrowthInv)~asin(sqrt(RA)), data=subset(SummaryInd,RA>0))
summary(mod)
plot(mod)

yvar <- "GrowthInv"
xvar <- "RA"

data <- subset(SummaryInd,RA>0)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  asin(sqrt(x[[xvar]]))))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```


#RA vs RGR - 
1. this is another way to look at the growth-reproduction trade-off 
2. similar to the plots of RA vs Growth Investment, but relationships stronger. For these plots, all but one species (PEPU) have a significantly negative slope  
3. the results are more of less the same regardless of whether one includes or excluded individuals where RA=0  
4. PEPU an exception because so few individuals reproducing and those that are reproducing have intermediate RGR - neither the young plants nor the older plants just hanging on  
5. PELA doesn't have a relationship either, because so few reproducing individuals. But if the many individuals with RA=0 added back in, strong negative relationship for PELA  

```{r, echo=FALSE,message=FALSE}
plot(RA~RGR, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(ReproInv~RGR, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA~RGR, SummaryInd, log="x", col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

plot(RA_mean~GrowthInv_mean,SummarySppAge,log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RGR~RA, data=subset(SummaryInd,RA>0), log="xy", col=col.spp[as.factor(species)],pch=16)
legend("topright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")
mod <- lm(log(GrowthInv)~asin(sqrt(RA))*species, data=subset(SummaryInd,RA>0))
summary(mod)
anova(mod)
plot(mod)

yvar <- "RGR"
xvar <- "RA"

data <- subset(SummaryInd,RA>0&RGR>.04)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  asin(sqrt(x[[xvar]]))))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}

yvar <- "RGR"
xvar <- "ReproInv"

data <- subset(SummaryInd,RA>0&RGR>.04)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  (log(x[[xvar]]))))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```


#Reproductive Investment by scaled height 
For these calculations, height is scaled relative to max height. This should be a way to determine RSOM - RSOM would be the PropH at which Reproductive Investment begins.
For species such as BOLE which begin reproduction so young, data could be included that have pre-reproductive heights from mid-year censuses of "babies"

```{r, echo=FALSE, message=FALSE}
plot((RA~PropH), SummaryInd, col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot((RA)~PropH, SummaryInd, col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "PropH"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm((x[[yvar]]) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```


These plots show very clearly that for all species RGR suddenly dips when RA becomes non-zero. Plotting against "total_weight" or "GrowthInvestment" is much less clear - in other words, an individual's height is the best way to sort them into plants investing more in growth vs reproduction. There are of course some non-reproductive plants with "PropH" above the obvious cut-off, but these are almost certainly "reproductively mature" plants not reproducing in a given year.  



Model analyzed is: lm(log([[GrowthInv]]) ~  asin(sqrt([[RA]]))*asin(sqrt([[PropH]]))))

The canopy species have, not suprisingly, a very obvious maxH, with Growth Investment or RGR tapering markedly at the maxH is approached. In these species growth investment is poorly correlated with RA, but well correlated with height.  
In some of the mid-height species (GRSP, BOLE, GRBU), growth investment is very poorly correlated with height, but well correlated with RA - in other words, increased RA = less growth.
Some species are correated with neither.  

Now my current analyses still lack the ability to tease apart the most obvious pattern - because I don't actually want to show that growth and height are correlated, so much as that the asymptoting of growth is correlated with height - i.e. the change in slope of the relationship.
```{r, echo=FALSE, message=FALSE}
yvar <- "GrowthInv"
xvar <- "RA"
x2var <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  asin(sqrt(x[[xvar]]))*asin(sqrt(x[[x2var]]))))
results <- summarise_all_fits_2var(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
names(results) <- c("species","r.sq_total","p-total","n","intercept","coef_RA","coef_PropH","coef_interaction","SS_RA","SS_PropH","SS_interaction")
results

yvar <- "GrowthInv"
xvar <- "PropH"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  asin(sqrt(x[[xvar]]))))
results2 <- summarise_all_fits(lmfits)

results2$r.squared <- round(results2$r.squared,digits=3)
results2$p.value <- round(results2$p.value,digits=3)
names(results2) <- c("species","r.sq.PropH","p.PropH","n","a","b")
results2

yvar <- "GrowthInv"
xvar <- "RA"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  asin(sqrt(x[[xvar]]))))
results3 <- summarise_all_fits(lmfits)

results3$r.squared <- round(results3$r.squared,digits=3)
results3$p.value <- round(results3$p.value,digits=3)
names(results3) <- c("species","r.sq.RA","p.RA","n","a","b")
results3

results <- merge(results, select(results2, -n, -a,-b), by="species")
results <- merge(results, select(results3, -n, -a,-b), by="species")
results
```



