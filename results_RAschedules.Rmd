```{r, echo=FALSE,results='hide', message=FALSE}
library(remake)
create_bindings()

source("scripts/summary_dataframes.R")
```
#RV curves and RA schedules, general patterns
- RA best plotted against height for many species - much clearer pattern than against weight or age - this seems to support Daniel's suspicion that deadwood shouldn't be included in the "weight" of the plant
- A number of species show an abrupt decrease in RGR (or tapering of growth investment) at the height where reproduction begins. This is evidence of the growth-reproduction trade-off
- RV curves are mostly quite pretty, but not necessarily very meaningful

#Generic functions for most plotting below
```{r, echo=FALSE, message=FALSE}
plot_yvar_vs_xvar <- function(data, yvar = "y", xvar = "x", ...) {
  Y <- data[[yvar]]
  X <- data[[xvar]]
  plot(Y ~ X, data=data,  cex.axis=.8, las=1, pch=16, ...)
}

summarise_fit <- function(x) {
  data.frame(
    select(glance(x), r.squared, p.value),
    n= length(resid(x)),
    a = coef(x)[1],
    b = coef(x)[2]
  )
}

summarise_all_fits <- function(x) {
  tmp <- lapply(x, summarise_fit) %>%
    bind_rows
  data.frame(species=names(x), tmp)
}

summarise_fit_2var <- function(x) {
  data.frame(
    select(glance(x), r.squared, p.value),
    n= length(resid(x)),
    intercept = coef(x)[1],
    coef_var1 = coef(x)[2],
    coef_var2 = coef(x)[3],
    coef_var1var2 = coef(x)[4],
    SS_var1 = anova(x)[1,2],
    SS_var2 = anova(x)[2,2],
    SS_var1var2 =anova(x)[3,2]
      )
}

summarise_all_fits_2var <- function(x) {
  tmp <- lapply(x, summarise_fit_2var) %>%
    bind_rows
  data.frame(species=names(x), tmp)
}
```


#RV curves
These are mostly reasonably nice - of course need to fit quadratic curve to these and haven't figured out how to do it correctly

```{r, echo=FALSE,message=FALSE}
plot(ReproInv~FinalWeight, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(ReproInv~FinalWeight, SummaryInd, log="xy", col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

plot((1+ReproInv_mean)~FinalWeight_mean,SummarySppAge,log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "ReproInv"
xvar <- "FinalWeight"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]+1) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

#RV curves (by age)
```{r, echo=FALSE,message=FALSE}
plot(ReproInv~age, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend(15,5000,legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot((1+ReproInv_mean)~age,SummarySppAge,log="xy", col=col.spp[as.factor(species)],pch=16)
legend(15,5000,legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "ReproInv"
xvar <- "age"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]+1) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

#RA schedules (vs. propH)
- these curves are particularly good for a number of species such as EPMI, COER, PELA
- they also show that for PILI that among individuals that reproduce, the "potential" RA decreases with increasing propH

```{r, echo=FALSE, message=FALSE}
plot((RA~PropH), SummaryInd, col=col.spp[as.factor(species)],pch=16)
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA~PropH, SummaryInd, col=col.age[as.factor(age)],pch=16)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(asin(sqrt(x[[yvar]])) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,
                    main=spp, xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

#RA schedules (by age)
```{r, echo=FALSE,message=FALSE}
plot(RA~age, SummaryInd, log="x", col=col.spp[as.factor(species)],pch=16)
legend(15,.9,legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA_mean~age,SummarySppAge,log="x", col=col.spp[as.factor(species)],pch=16)
legend(15,.5,legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "age"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm((x[[yvar]]) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="x", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```


#RA schedules (by size)
```{r, echo=FALSE,message=FALSE}
plot(RA~FinalWeight, SummaryInd, log="x", col=col.spp[as.factor(species)],pch=16)
legend("topright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA_mean~FinalWeight_mean,SummarySppAge,log="x", col=col.spp[as.factor(species)],pch=16)
legend("topright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "FinalWeight"

data <- SummaryInd
data <- split(data, data$species)

lmfits <- lapply(data, function(x) lm((x[[yvar]]) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="x", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```


#Reproductive Investment by Growth Investment
Overall, these are not a strong set of results, but HATE shows a very strong relationship that shows reproductive investment (not growth investment) asymptoting
Interestingly, PHPH, which is generally a complete scatter plot, has one of the strongest correlations between these variables, indicating that indeed most measures of "size" for this multi-stemmed plant aren't very meaningful and it should be analyzed differently.

Note that the analyses are just being done on reproducing individuals at the moment.
```{r, echo=FALSE,message=FALSE}
plot((1+ReproInv)~GrowthInv, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot((1+ReproInv)~GrowthInv, SummaryInd, log="xy", col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

plot((1+ReproInv_mean)~GrowthInv_mean,SummarySppAge,log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "GrowthInv"
xvar <- "ReproInv"

data <- subset(SummaryInd,RA>0)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]+1) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```

#RA by Growth Investment
Across all species, high RA = low growth investment. This pattern exists mostly because of shifts in species from high reproducers to high growers - i.e. BOLE in one corner, and BAER & HATE in another.
For analyses within individual species
```{r, echo=FALSE,message=FALSE}
plot(RA~GrowthInv, SummaryInd, log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA~GrowthInv, SummaryInd, log="x", col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

plot(RA_mean~GrowthInv_mean,SummarySppAge,log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(GrowthInv~RA, data=subset(SummaryInd,RA>0), log="y", col=col.spp[as.factor(species)],pch=16)
legend("topright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")
mod <- lm(log(GrowthInv)~asin(sqrt(RA)), data=subset(SummaryInd,RA>0))
summary(mod)
plot(mod)

yvar <- "GrowthInv"
xvar <- "RA"

data <- subset(SummaryInd,RA>0)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  asin(sqrt(x[[xvar]]))))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```


#RA vs RGR - 
similar to the plots of RA vs Growth Investment, but relationships stronger. For these plots, all but one species (PEPU) have a significantly negative slope
the results are more of less the same regardless of whether one includes or excluded individuals where RA=0
```{r, echo=FALSE,message=FALSE}
plot(RA~RGR, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA~RGR, SummaryInd, log="x", col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

plot(RA_mean~GrowthInv_mean,SummarySppAge,log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RGR~RA, data=subset(SummaryInd,RA>0), log="xy", col=col.spp[as.factor(species)],pch=16)
legend("topright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")
mod <- lm(log(GrowthInv)~asin(sqrt(RA)), data=subset(SummaryInd,RA>0))
summary(mod)
plot(mod)

yvar <- "RGR"
xvar <- "RA"

data <- subset(SummaryInd,RA>0)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  asin(sqrt(x[[xvar]]))))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="xy", xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```


#Reproductive Investment by scaled height 
For these calculations, height is scaled relative to max height. This should be a way to determine RSOM - RSOM would be the PropH at which Reproductive Investment begins.
For species such as BOLE which begin reproduction so young, data could be included that have pre-reproductive heights from mid-year censuses of "babies"

```{r, echo=FALSE, message=FALSE}
plot((RA~PropH), SummaryInd, col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot((RA)~PropH, SummaryInd, col=col.age[as.factor(age)],pch=16)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "PropH"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm((x[[yvar]]) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, xlab=xvar, ylab=yvar)
  
  abline(lmfits[[spp]])
}
```


These plots show very clearly that for all species RGR suddenly dips when RA becomes non-zero. Plotting against "FinalWeight" or "GrowthInvestment" is much less clear - in other words, an individual's height is the best way to sort them into plants investing more in growth vs reproduction. There are of course some non-reproductive plants with "PropH" above the obvious cut-off, but these are almost certainly "reproductively mature" plants not reproducing in a given year.  

The canopy species have, not suprisingly, a very obvious maxH, with Growth Investment or RGR tapering markedly at the maxH is approached. In these species growth investment is poorly correlated with RA, but well correlated with height.  
In some of the mid-height species (GRSP, BOLE, GRBU), growth investment is very poorly correlated with height, but well correlated with RA - in other words, increased RA = less growth.
Some species are correated with neither.  

Now my current analyses still lack the ability to tease apart the most obvious pattern - because I don't actually want to show that growth and height are correlated, so much as that the asymptoting of growth is correlated with height - i.e. the change in slope of the relationship.

```{r, echo=FALSE, message=FALSE}
yvar <- "GrowthInv"
xvar <- "RA"
x2var <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  asin(sqrt(x[[xvar]]))*asin(sqrt(x[[x2var]]))))
results <- summarise_all_fits_2var(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, log="y",
                    main=spp, xlab=xvar, ylab=yvar)
  abline(lmfits[[spp]])
}
```



