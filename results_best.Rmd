```{r, echo=FALSE,results='hide', message=FALSE}
library(remake)
create_bindings()

source("scripts/summary_dataframes.R")

plot_yvar_vs_xvar <- function(data, yvar = "y", xvar = "x", ...) {
  Y <- data[[yvar]]
  X <- data[[xvar]]
  plot(Y ~ X, data=data,  cex.axis=.8, las=1, pch=16, ...)
}

summarise_fit <- function(x) {
  data.frame(
    select(glance(x), r.squared, p.value),
    n= length(resid(x)),
    a = coef(x)[1],
    b = coef(x)[2]
  )
}

summarise_all_fits <- function(x) {
  tmp <- lapply(x, summarise_fit) %>%
    bind_rows
  data.frame(species=names(x), tmp)
}

summarise_fit_2var <- function(x) {
  data.frame(
    select(glance(x), r.squared, p.value),
    n= length(resid(x)),
    intercept = coef(x)[1],
    coef_var1 = coef(x)[2],
    coef_var2 = coef(x)[3],
    coef_var1var2 = coef(x)[4],
    SS_var1 = anova(x)[1,2],
    SS_var2 = anova(x)[2,2],
    SS_var1var2 =anova(x)[3,2]
      )
}

summarise_all_fits_2var <- function(x) {
  tmp <- lapply(x, summarise_fit_2var) %>%
    bind_rows
  data.frame(species=names(x), tmp)
}
```

#Ideas and plots to include in a paper looking at the ways in which reproductive investment impacts growth
* Part of this paper would be to look at how different "types of" species fall out with respect to the various plots - i.e. canopy species (BAER, HATE, PELA), short-lived species (BOLE, PILI, COER), longer-lived understory species 
* Plants that grow more also reproduce more, but plants that allocate more to reproduction have lower RGR (Same paper as RA curves?)
* There is a disinct decline in RGR (or Growth Investment) at the exact "PropH" that plants begin to reproduce (Same paper as RA curves?)

##Growth-reproduction trade-off
###Bigger plants reproduce more
- There is a positive correlation between reproductive investment vs growth investment among individuals that are reproducing: plants that grow more also allocate more to reproduction.  
- It is also true that bigger plants allocate more to reproduction.  

```{r, echo=FALSE,message=FALSE}
plot((1+ReproInv)~GrowthInv, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")
```

###Plants that allocate more to reproduction (higher RA) have a lower RGR
- When looked at individually, this pattern holds for all species except PEPU and PELA, although there is lots of variation in the exact trade-off pattern displayed by different species  
- You can also look at the plots of RGR vs RA and identify the RA at which RGR is impacted. Some plots show a very linear decline throught, whereas for others there is a distinct "knickpoint" -i.e. BOLE, EPMI, HATE   

```{r, echo=FALSE,message=FALSE}
plot(RA~RGR, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

mod <- lm(RGR~asin(sqrt(RA))*species,SummaryInd)
anova(mod)
```

###More ways to ask how much - and when - reproduction impacts growth  
- It is clear that different species reach a different "proportion maxH" (RSOM) before reproducing. Need to do curve fitting to determine where this occurs.  
- The plot of Growth Investment vs. PropH shows a decrease in growth rate at a given PropH (for most species). Is this the same PropH at which reproduction begins?  
- It seems that some of the early reproducers begin reproducing at a larger PropH, as predicted by others. But because they allocate so much to reproduction, their growth rate declines more precipitously with the onset of reproduction.  

#Ideas and plots to include in RA schedule paper
* I have a dataset with enough resolution across species and ages to show patterns of growth and reproductive investment across ages  
* This includes both RA schedules and RV curves, as well as other potential plots  


###RV curves (by proportion max H)
- In a sense, by using proportion max H, these figures are showing the proportion of total growth the plant undergoes before starting reproduction
- You could also plot against "PropMaxWeight", the proportion of the heaviest individual of that species. The two measures look "best" for different species
```{r, echo=FALSE,message=FALSE}
plot((ReproInv)~(PropH), SummaryInd, log="y",col=col.spp[as.factor(species)],pch=16,xlim=c(4e-03,1))
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "ReproInv"
xvar <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]+1) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="y", xlab=xvar, ylab=yvar)
}
```

#RA schedules (vs. propH)  
- these curves are particularly good for a number of species such as EPMI, COER, PELA  
- they also show that for PILI that among individuals that reproduce, the "potential" RA decreases with increasing propH  
- when all data points are included, all species except PEPU, PHPH, and PULU show increasing RA with increasing height  
- when RA =0 is excluded, the following species still have a significant positive correlation: BOLE, COER, EPMI, GRBU, GRSP, HATE. LEES and PELA have a p-value between 0.05-0.10   
- PEPU has a negative correlation - matches Mark's suggestion that it is "hanging on"  
- There are species - such as BOLE - which have a much "cleaner" plot against age instead of PropH (or any other size measure). This indicates that these species are programmed to reproduce at a certain "rate" regardless of their size  

 NOTE: Again, a linear line is not necessarily the most appropriate 

```{r, echo=FALSE, message=FALSE}
plot((RA~PropH), SummaryInd, col=col.spp[as.factor(species)],pch=16)
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA~PropH, SummaryInd, col=col.age[as.factor(age)],pch=16)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "PropH"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(asin(sqrt(x[[yvar]])) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,
                    main=spp, xlab=xvar, ylab=yvar)
}
```

###To think about regarding RA schedules and RV curves
- What does it mean that PropH is the better correlate that plant weight?  
1. That "plant weight" is a mis-leading number, since it includes dead "heartwood"  
2. That this is a community where height is the most important variable? Because height = light access or because of some relationship between height and leaf area.  
** Once I have leaf weights, I'll be curious how leaf weight plots against PropH, this might be more of the story  
