```{r, echo=FALSE,results='hide', message=FALSE}
library(remake)
create_bindings()

source("scripts/summary_dataframes.R")

plot_yvar_vs_xvar <- function(data, yvar = "y", xvar = "x", ...) {
  Y <- data[[yvar]]
  X <- data[[xvar]]
  plot(Y ~ X, data=data,  cex.axis=.8, las=1, pch=16, ...)
}

summarise_fit <- function(x) {
  data.frame(
    select(glance(x), r.squared, p.value),
    n= length(resid(x)),
    a = coef(x)[1],
    b = coef(x)[2]
  )
}

summarise_all_fits <- function(x) {
  tmp <- lapply(x, summarise_fit) %>%
    bind_rows
  data.frame(species=names(x), tmp)
}

summarise_fit_2var <- function(x) {
  data.frame(
    select(glance(x), r.squared, p.value),
    n= length(resid(x)),
    intercept = coef(x)[1],
    coef_var1 = coef(x)[2],
    coef_var2 = coef(x)[3],
    coef_var1var2 = coef(x)[4],
    SS_var1 = anova(x)[1,2],
    SS_var2 = anova(x)[2,2],
    SS_var1var2 =anova(x)[3,2]
      )
}

summarise_all_fits_2var <- function(x) {
  tmp <- lapply(x, summarise_fit_2var) %>%
    bind_rows
  data.frame(species=names(x), tmp)
}

xy.error.bars <- function (x,y,xbar,ybar) {
  plot(x,y,pch=16, ylim=c(min(y-ybar),max(y+ybar)),xlim=c(min(x-xbar),max(x+xbar)))
  arrows(x,y-ybar,x,y+ybar,code=3,angle=90, length=0.1)
  arrows(x-xbar,y,x+xbar,y,code=3,angle=90, length=0.1)
}

se_function <- function(mean1,se1) {
for(i in 1:14) {
arrows(i,mean1[i]+se1[i],i,mean1[i]-se1[i],code=3,angle=90, length=0.1)
}
}
```

#Changes in growth and tissue allocation with age and size
* Part of this paper would be to look at how different "types of" species fall out with respect to the various plots - i.e. canopy species (BAER, HATE, PELA), short-lived species (BOLE, PILI, COER), longer-lived understory species 


###More ways to ask how much - and when - reproduction impacts growth  
- It is clear that different species reach a different "proportion maxH" (RSOM) before reproducing. Need to do curve fitting to determine where this occurs.  
- The plot of Growth Investment vs. PropH shows a decrease in growth rate at a given PropH (for most species). Is this the same PropH at which reproduction begins?  
- It seems that some of the early reproducers begin reproducing at a larger PropH, as predicted by others. But because they allocate so much to reproduction, their growth rate declines more precipitously with the onset of reproduction.  

#RA schedule paper
* I have a dataset with enough resolution across species and ages to show patterns of growth and reproductive investment across ages  
* This includes both RA schedules and RV curves  
* Below are curves plotted relative to "PropH", which is a better fit for most species - but other species should be plotted against total plant weight  
* Plants that grow more also reproduce more, but plants that allocate more to reproduction have lower RGR 
* There is a disinct decline in RGR (or Growth Investment) at the exact "PropH" that plants begin to reproduce 
* Plotting reproductive investment (ReproInv) against RGR yields a much lower r^2 - for every single species. Only RA captures the actual trade-off incurred by plants that allocate more to reproduction, showing one way RA schedules are important  
  - As discussed in the review, RA schedule differentiate between greater reproductive output because you are bigger (a positive correlation with plant growth) and greater reproductive output because you are allocating more to reproduction (a negative correlation with plant growth)  
* RV curves continue to be the more relevent metric to determine the actual amount of reproductive output produced by a plant of a given size or height  

##RV curves (by proportion max H)
- In a sense, by using proportion max H, these figures are showing the proportion of total growth the plant undergoes before starting reproduction
- The plot across all species of reproductive investment vs. Prop H is much less tight than reproductive investment vs. total weight, but within a species not as obviously different  
- The plot that includes all species shows that *once* a given species has ramped up reproduction, the log-log plot of reproductive investment vs final weight is nearly linear across all species; in other words, to first order, all species allocate the same amount to reproduction relative to their weight.  
- This is presumably the basic allometric scaling relationship discussed by others and wondering if slope I get is same as theirs    
- However, it is important to note that species early in their reproductive trajectory do not follow this pattern  
```{r, echo=FALSE,message=FALSE}
plot((ReproInv)~(PropH), SummaryInd, log="y",col=col.spp[as.factor(species)],pch=16,xlim=c(4e-03,1))
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(ReproInv~FinalWeight, SummaryInd, log="xy",col=col.spp[as.factor(species)],pch=16)
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(ReproInv~height, SummaryInd, log="xy",col=col.spp[as.factor(species)],pch=16)
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "ReproInv"
xvar <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]+1) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar, 
                    main=spp, log="y", xlab=xvar, ylab=yvar)
}
```

##RA schedules (vs. propH)  
- RA schedules still look "best" plotted against age; not shown here  
- these curves are particularly good for a number of species such as EPMI, COER, PELA  
- they also show that for PILI that among individuals that reproduce, the "potential" RA decreases with increasing propH  
- when all data points are included, all species except PEPU, PHPH, and PULU show increasing RA with increasing height  
- when RA =0 is excluded, the following species still have a significant positive correlation: BOLE, COER, EPMI, GRBU, GRSP, HATE. LEES and PELA have a p-value between 0.05-0.10   
- PEPU has a negative correlation - matches Mark's suggestion that it is "hanging on"  
- There are species - such as BOLE - which have a much "cleaner" plot against age instead of PropH (or any other size measure). This indicates that these species are programmed to reproduce at a certain "rate" regardless of their size  

 NOTE: Again, a linear line is not necessarily the most appropriate 

```{r, echo=FALSE, message=FALSE}
plot((RA~PropH), SummaryInd, col=col.spp[as.factor(species)],pch=16)
legend("topleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(RA~PropH, SummaryInd, col=col.age[as.factor(age)],pch=16)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=.8,bty="n")

yvar <- "RA"
xvar <- "PropH"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(asin(sqrt(x[[yvar]])) ~  (x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,
                    main=spp, xlab=xvar, ylab=yvar)
}
```

##Growth-reproduction trade-off
###Bigger plants reproduce more
- There is a positive correlation between reproductive investment vs growth investment among individuals that are reproducing: plants that grow more also allocate more to reproduction.  
- It is also true that bigger plants allocate more to reproduction.  

```{r, echo=FALSE,message=FALSE}
plot((1+ReproInv)~GrowthInv, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomright",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")
```

###Plants that allocate more to reproduction (higher RA) have a lower RGR
- When looked at individually, this pattern holds for all species except PEPU and PELA, although there is lots of variation in the exact trade-off pattern displayed by different species  
- You can also look at the plots of RGR vs RA and identify the RA at which RGR is impacted. Some plots show a very linear decline throught, whereas for others there is a distinct "knickpoint" -i.e. BOLE, EPMI, HATE   

```{r, echo=FALSE,message=FALSE}
plot(RA~RGR, SummaryInd, log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

mod <- lm(RGR~asin(sqrt(RA))*species,SummaryInd)
anova(mod)
```

###To think about regarding RA schedules and RV curves
- What does it mean that PropH is the better correlate that plant weight?  
1. That "plant weight" is a mis-leading number, since it includes dead "heartwood"  
2. That this is a community where height is the most important variable? Because height = light access or because of some relationship between height and leaf area.  
** Once I have leaf weights, I'll be curious how leaf weight plots against PropH, this might be more of the story  

###Looking jointly at effects of RA and PropH on growth inveestment
- Model analyzed is: lm(log([[GrowthInv]]) ~  asin(sqrt([[RA]]))*asin(sqrt([[PropH]]))))  
- The canopy species have, not suprisingly, a very obvious maxH, with Growth Investment or RGR tapering markedly at the maxH is approached. In these species growth investment is poorly correlated with RA, but well correlated with height.  
- In some of the mid-height species (GRSP, BOLE, GRBU), growth investment is very poorly correlated with height, but better correlated with RA - in other words, increased RA = less growth.  
- One of the difficult features interpreting this, is that there are species with overall higher correlations and overall lower correlations, and this pattern dominates, not the relative strength  
- My current analyses still lack the ability to tease apart the most obvious pattern - because I don't actually want to show that growth and height are correlated, so much as that the   asymptoting of growth is correlated with height - i.e. the change in slope of the relationship.  
```{r, echo=FALSE, message=FALSE}
yvar <- "GrowthInv"
xvar <- "RA"
x2var <- "PropH"

data <- SummaryInd
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(log(x[[yvar]]) ~  asin(sqrt(x[[xvar]]))*asin(sqrt(x[[x2var]]))))
results <- summarise_all_fits_2var(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
names(results) <- c("species","r,squared","p-value","n","intercept","coef_RA","coef_PropH","coef_interaction","SS_RA","SS_PropH","SS_interaction")
results
```


#Shifts in accessory costs across species and ages
##Overall results
- Accessory costs higher for bigger seeds  
- Accessory costs higher for bigger species; these are the same species that invest less in RA  
- Of course there is also a correlation between seed size and plant size, but actually not as strong as the accessory cost one, presumably because older plants have lower accessory costs as well as species that are inherently bigger  
- A number of species show fairly consistent declines in accessory costs with various measures of "bigger", including size, age, RA. Other species show no patterns  
- Lower pre-pollination costs in plants with higher RA: 9 (of 14) species decrease the proportion of reproductive investment in "pre-pollination" tissues as their RA increases. in other words, they get better returns on investment the more they invest. (This is just a pattern within, not across, species)  
- Species very different in which accessory tissues they invest the most in - which reflects the differences in basic structure (i.e. Banksia cones), but also more subtlely that some species abort lots of buds (pre-pollination aborted), while other species abort more fully formed flowers  
- Haven't actually run all the rest, but assume all reproductive tissue types will differ in proportional allocation across species
- For most of the statistical analyses, the youngest site has been removed, since it included individuals that were harvested while flowering (and therefore never "got to" set fruit) and automatically have no "successful" reproduction. There are of course some individuals like this at other ages as well, but far fewer  

###How do accessory costs shift with seed size?
- Larger-seeded species have higher accessory costs. 
- Also shown in other studies and suggested as a mechanism for why angiosperms were able to have such small seeds (relative to gymnosperms, with no decrease in proportional accessory costs - with decreasing size)  
```{r, echo=FALSE,message=FALSE}
yvar <- "PerAcc_mean"
xvar <- "seed_size"
data <- SummarySpp

plot_yvar_vs_xvar(data, yvar, xvar,log="x",
                  xlab=xvar, ylab=yvar)
mod <- lm(log(seed_size)~PerAcc_mean,SummarySpp)
summary(mod)
anova(mod)
```
###Size versus proportion propagule
- Species that are bigger (by weight) invest a lower proportion of their reproduction in propagules  
- This is a much stronger relationship than shifts in RA by plant size  
- There is also no relationship between RA and proportion of energy invested in propagules  
- The model including both PerPropagule and RA confirms this - there is a strong species effect and strong PerPropagule effect, but RA not significant  
   
* This means: The larger species get less of a return on their investment in reproduction. They have higher accessory costs.  

- Species with larger seeds also have higher accessory costs - what we don't know is if "seed size" or "plant size" that is most important  
- I've also included the plot of "Propagule Allocation", the proportion of total surplus energy allocated to propagules, which combines the RA and Proportion Propagule effects  
- Not shown, but there is a just barely significant relationship between RA and PerPropagule - in other words, although bigger species have slightly lower RA values than smaller species, this is not an important trend  
  
- Overall with plant weight:  
within species:  
- greater plant weight = higher RA  (plants allocate more to reproduction when bigger/older)**
- plant weight = little effect on proportion to propagules  
- plant weight = little effect on pre-pollination tissues  
  
across species  
- greater plant weight = lower RA  (spending more on growth and survival)**
- greater plant weight = lower proportion to propagules  (bigger species get less for their allocation)**
- plant weight = little effect on pre-pollination tissues  

finally,

within species:
- higher RA = lower allocation to pre-pollination tissues (compounding returns)**

```{r, echo=FALSE, message=FALSE}
plot(PerPropagule ~FinalWeight, data=subset(SummaryInd,RA>0&PerPropagule>0),log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

mod <- lm(log(FinalWeight) ~ (log(PerPropagule))*species,data=subset(SummaryInd,PerPropagule>0))
summary(mod)
anova(mod)

plot(PropAllocation ~FinalWeight, data=subset(SummaryInd,RA>0&PerPropagule>0),log="xy", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

mod <- lm(log(FinalWeight) ~ (log(PropAllocation))*species*age,data=subset(SummaryInd,PerPropagule>0))
summary(mod)
anova(mod)

#plot(RA ~FinalWeight, data=subset(SummaryInd,RA>0&PerPropagule>0),log="xy", col=col.spp[as.factor(species)],pch=16,ylim=c(.02,1))
#legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

#plot(PerPropagule ~RA, data=subset(SummaryInd,RA>0&PerPropagule>0),log="xy", col=col.spp[as.factor(species)],pch=16)
#legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

```


###Shifts in proportional pre-pollination costs with plant weight
- No pattern within or across species when plotted against size  
- However, higher RA = lower pre-pollination costs

```{r, echo=FALSE, message=FALSE}
mean1 <- SummarySpp$PerPrePol_All_mean
se1 <- SummarySpp$PerPrePol_All_se

plot(mean1~species,SummarySpp,cex.axis=.8,pch=16,ylim=c(.1,1),main="Percent reproductive investment put into packaging and dispersal")
se_function(mean1,se1)

plot(asin(sqrt(PerPrePol_All))~FinalWeight, data=subset(SummaryInd,PerPrePol_All>0),log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "PerPrePol_All"
xvar <- "FinalWeight"

data <- subset(SummaryInd, Total>0)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(asin(sqrt(x[[yvar]])) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

plot(asin(sqrt(PerPrePol_All))~RA, data=subset(SummaryInd,PerPrePol_All>0),log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "PerPrePol_All"
xvar <- "RA"

data <- subset(SummaryInd, Total>0)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(asin(sqrt(x[[yvar]])) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results
```

#Shifts in packaging and dispersal costs with plant weight
- Species very different from one another, but no shift with size  
- However quite a few species (BAER, BOLE, COER, GRBU. GRSP, HATE, HEPU, PILI increase the percent reproductive investment spent on packaging and dispersal with age  
```{r, echo=FALSE, message=FALSE}
plot(asin(sqrt(PerPackDisp)) ~FinalWeight, data=subset(SummaryInd,PerPackDisp>0),log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

plot(asin(sqrt(PerPackDisp)) ~RA, data=subset(SummaryInd,PerPackDisp>0),log="x", col=col.spp[as.factor(species)],pch=16)
legend("bottomleft",legend=names(labels.spp),col=col.spp,pch=16, cex=.8,bty="n")

yvar <- "PerPackDisp"
xvar <- "FinalWeight"

data <- subset(SummaryInd, Total>0)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(asin(sqrt(x[[yvar]])) ~  log(x[[xvar]])))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

mean1 <- SummarySpp$PerPackDisp_mean
se1 <- SummarySpp$PerPackDisp_se

plot(mean1~species,SummarySpp,cex.axis=.8,pch=16,log="y",ylim=c(.01,1),main="Percent reproductive investment put into packaging and dispersal")
se_function(mean1,se1)
```

### Shifts in PerPropagule and RA within species
- The above models indicate that there is no overall "PerPropagule" by "species" interaction. Looking at individual species also indicates few species show a pattern - those that do show an increase in propagule investment (decreasing accessory costs) with increasing size
    - COER, HATE, and PILI show a significant decrease in accessory costs with increasing size (p<0.05)  
    - GRSP shows a marginally significant decrease in accessory costs with increasing size (0.05<p<0.10)  
    - PEPU shows a marginally significant INCREASE in accessory costs with increasing size (0.05<p<0.10)  
    - the plots are in the file with all accessory tissues results
    
- There is of course also an increase in RA with increased plant weight (see RA section)
- An added piece of this, is that WITHIN species, there is an INCREASE in allocation to propagules with increasing size (age) for many species
    - BAER, COER, GRBU, GRSP, HATE, LEES, PELA, PEPU show a significant decrease in accessory costs with increasing RA (p<0.05)  
    - BOLE shows a marginally significant decrease in accessory costs with increasing RA (p ~ 0.10) 
    
```{r, echo=FALSE, message=FALSE}
yvar <- "PerPropagule"
xvar <- "FinalWeight"

data <- filter(SummaryInd,Total>0)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(asin(sqrt(x[[yvar]])) ~ log(x[[xvar]])))

results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

yvar <- "PerPropagule"
xvar <- "RA"

data <- filter(SummaryInd,Total>0&age>2)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm(asin(sqrt(x[[yvar]])) ~  asin(sqrt(x[[xvar]]))))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results
```

###Do species differ in the proportional energy allocated to propagules (vs. accessory tissues)  
- COER, EPMI, LEES, PILI invest the most energy in propagules  
- HATE invests by far the least into propagules

```{r, echo=FALSE, message=FALSE}
yvar <- "PerPropagule"
xvar <- "species"
data <- filter(SummaryInd,Total>0)

mod <- lm(asin(sqrt(PerPropagule)) ~ species-1, data)
summary(mod)
data.frame(
    select(glance(mod), r.squared, p.value),
    n= length(resid(mod)),
    a = coef(mod)[1],
    b = coef(mod)[2]
  )

tmp <- summary(mod)
tmp <- tmp$coefficients
tmp <-as.data.frame(tmp)
tmp <- cbind(names(labels.spp),tmp)
names(tmp) <- c("species","estimate.trans","se.trans","t.value","p.value")
tmp2 <- select(SummarySpp, species, PerPropagule_mean, PerPropagule_se)
tmp <- merge(tmp, tmp2, by="species")
tmp
plot(PerPropagule_mean~species,tmp,cex.axis=.8,pch=16,log="y",ylim=c(.001,.25),main="Percent reproductive investment put into propagules")

mean1 <- tmp$PerPropagule_mean
se1 <- tmp$PerPropagule_se

se_function(mean1,se1)
```


