---
output: html_document
---
#file names
- leaf_counts is file with calculated leaf counts and leaf lifespan data
- SummarySppAge is file with means of LL - and other variables - by species and age; LMA data is merged to this file
- subsets of SummarySppAge are created to omit babies or HATE for various analyses

#variables in my dataset
Measures of biomass and growth include:
- basal diameter
- "leader" diameter
- total biomass
- leaf mass
- leaf area
- stem biomass (calculations not yet done)
- leaf count along leaders
- shoot extension

* all these can be plotted against age as actual values or as change from a year earlier
* these measures are all done at the level of "individual" with 7 individuals of each species at each of 6 sites

Reproduction measures include:
- total reproductive investment (biomass)
- RA (ratio of reproductive investment to total surplus energy)
- investment in each of 5 different categories of reproductive investment:
  * tissues aborted pre-pollination (ie. aborted bud)
  * tissues that reach their final pre-pollination stage (i.e. open flower)
  * tissues aborted after pollination (i.e. aborted immature fruit)
  * tissues associated with packaging and dispersal of successful, mature fruit (i.e. cones, wings, seed pods)
  * the propagule itself (either the seed or the seed with fused fruit tissue)
- % investment in accessory tissues versus the propagule
- seed set (calculations not yet done)

  !!!TO DISCUSS: I only have my own seed weights for species where the seed isn't fused to any fruit tissue. However, I do have seed weights from the literature and global databases for all species and calculations could be redone based on actual seed weights for all species.!!!


Traits are:
- leaf lifespan (individuals)
- LMA (species * age = site)
- wood density (species)
- maximum height (species or site)
- seed size (species)

!!!TO DISCUSS: There are many way to calculate leaf lifespan, resulting in somewhat different patterns!!!

#previously observed patterns that are - fortunately - also true for my dataset
- correlation between LMA and leaf lifespan. (True when HATE is removed.)
- larger seeds have higher accessory costs

##GENERAL THOUGHTS (and conclusions)

#Leaf lifespan, LMA, leaf area, leaf weight changes with age:

In the field, it seemed that older plants had fewer leaves on their shoots, indicating either decreasing lower leaf lifespan (opposite accepted trend) and/or decreasing shoot extension with age.

* results show no overall change in leaf lifespan with age, although some species have slightly increasing leaf lifespan
* both the number of leaves on a shoot and shoot extension decline with age, with some species having quite dramatic shifts (and others no shift)
* TO DO: Total plant leaf area (and leaf number) with age, scaled to basal area and to stem weight
* TO DO: Plot leaf weight against height (same plot as Daniel used in the data paper in Ecology)

Revised thoughts: The leading shoots show a slight decline in leaf number with age. Overall, the plant will look a lot "leggier" because non-leading shoots with show less new growth and even fewer leaves. This pattern should be captured in by looking at shifts in the ratio of leaf count (or area) to basal stem area (ir total stem weight) across ages.

# overall LL, LMA results

- strong correlation between LMA and LL when all species*site combinations included
- LL variable across species, as expected; same for LMA
- LL does not change as plants age; LMA does not change as plants age
- leaf count along the leader decreases in older plants for many species - which is why LL appears to decrease

#Accessory costs

Accessory costs account for the vast majority of my plant's reproductive investment - and presumably for other perennial plants worldwide - but this is an often ignored pool.
* Overall, larger seeds have higher accessory costs (as has been shown for other angiosperm species and given as one of the reasons why angiosperms can have smaller seeds than gymnosperms)

While overall accessory costs are not clearly affected by age, several of the sub-categories do change with age:
- proportion of reproductive energy investment in aborted buds and flowers declines after the first few reproductive years

#Correlation between each of the five "traits" and growth and reproductive measures
* TO DO: Re

#discuss with Daniel
- once we are certain about leaf lifespan calculations, those calculations should go into a separate file, since that is background processing, but like calculating investment. Then this becomes the file where variables are summarized, plotted analyzed.
- add final leaf and stem biomass output to "investment" output file
- seed weight vs. propagule weight dilemma

technical:
-parts remake not working
-tag_ID still exists in 1 file
-avoiding duplicate columns with name "age" "species" (how to subset columns that are merged, how to delete columns)
-getting model summaries to show up when looping through species/ages

#next to do

- check how overall plant leaf numbers changes with age, diameter

#data to check
- HATE outlier in LL

```{r, echo=FALSE,results='hide', message=FALSE}

# load packages and "open" dataframes to use
library(remake)
create_bindings()
```

```{r, echo=FALSE,results='hide', message=FALSE}
LMA <- filter(LMA_raw, species!="" & species!=" ") %>%
  select(species,age,LMA,branch_age)

wood <- filter(woodDensity_raw, use=="use") %>%
  select(species,density)

seedsize <- seedSize_raw %>%
  select(species,seed_size)

harvest <- filter(HarvestData, use_status=="use" & segment==1 & start_end=="end") %>%
  select(species,individual,age,age2,height,total_leaf_weight,site)

investment <- ReproductionAllocation_all
investment$age2 <- investment$age
investment$age <- round(investment$age, digits=1)

accessory <- AccessoryCosts_all
accessory$age2 <- accessory$age
accessory$age <- round(accessory$age, digits=1)
#accessory$PerAccessory <- {
#  select(accessory, Total >0,
#  1 - (accessory$Prop/accessory$Total)
#}

#accessory$PerPropagule = 1 - accessory$PerAccessory

leafLifespan <- filter(leafLifespan_raw, dont_use!="dead" & dont_use!="dont_use") %>%
  select(species,age,individual,d_start,d_end,length_start,new_length,lvs_start_length,lvs_start_count,lvs_end_length,lvs_end_count,lvs_new_length,lvs_new_count,new_but_shed_count,mm_lvs_spec,count_lvs_spec)

leafLifespan$individual <- as.factor(leafLifespan$individual)
leafLifespan$species <- as.factor(leafLifespan$species)

#loading this column as character, so using this for now

# Calculating Leaf Lifespan

# where counts did not previously exists, set as 0; CHECK WITH DANIEL THAT "V" IS A SET "NAME" IN THESE FUNCTIONS

leaf_lifespan_temp <- leafLifespan %>%
              select(species,age,individual,d_start,d_end,length_start,new_length,lvs_start_count,lvs_end_count,lvs_new_count,new_but_shed_count)

for(v in c("lvs_start_count","lvs_end_count","lvs_new_count","new_but_shed_count")) {
  i <- is.na(leaf_lifespan_temp[[v]])
  leaf_lifespan_temp[[v]][i] <- 0
}

# For individuals with "length" measures, translate into count

# get average leaves per length for spp
leaves_per_length_spp <-  filter(leavesPerLength_raw,use=="yes") %>%
  mutate(count_per_length = leaf_count/length_mm) %>%
  group_by(species) %>%
  summarise(count_per_length = mean(count_per_length, na.rm=TRUE))

# get spp average for all individuals
leafLifespan$count_per_length <- leaves_per_length_spp$count_per_length[match(leafLifespan$species, leaves_per_length_spp$species)]

# if possible use data for that individual, if it exists; this code substitutes in species count per length #s for individuals where this data is available
i <- !is.na(leafLifespan$mm_lvs)
leafLifespan$count_per_length[i] <- (leafLifespan$count_lvs_spec/leafLifespan$mm_lvs)[i]

#this is the end of the section Daniel helped me rewrite - next section is mine

#get total leaf counts
for(v in c("lvs_start_length","lvs_start_count","lvs_end_length","lvs_end_count","lvs_new_length","lvs_new_count","new_but_shed_count")) {
  i <- is.na(leafLifespan[[v]])
  leafLifespan[[v]][i] <- 0
  }
leafLifespan$lvs_start <- leafLifespan$lvs_start_count + (leafLifespan$lvs_start_length * leafLifespan$count_per_length)
leafLifespan$lvs_end <- leafLifespan$lvs_end_count + (leafLifespan$lvs_end_length * leafLifespan$count_per_length)
leafLifespan$lvs_new <- leafLifespan$lvs_new_count + (leafLifespan$lvs_new_length * leafLifespan$count_per_length)

#calculating leaf lifespan
leafLifespan$LL_bd <- (leafLifespan$lvs_start)/(((leafLifespan$lvs_start)-(leafLifespan$lvs_end))+(leafLifespan$lvs_new)/2)
leafLifespan$LL_death <- (leafLifespan$lvs_start)/((leafLifespan$lvs_start)-(leafLifespan$lvs_end))
leafLifespan$LL_birth <- (leafLifespan$lvs_start)/(leafLifespan$lvs_new)

leafLifespan$LL_death[which(is.infinite(leafLifespan$LL_death))] <- NA
leafLifespan$LL_bd[which(is.infinite(leafLifespan$LL_death))] <- NA
leafLifespan$LL_birth[which(is.infinite(leafLifespan$LL_death))] <- NA

#adding investment and accessory costs data to leafLifespan dataframe to create a dataframe with all individual level data
SummaryInd <- merge(leafLifespan, select(investment, -species, -age), by="individual")
SummaryInd <- merge(SummaryInd, select(accessory, -species, -age, -age2), by="individual")
SummaryInd <- merge(SummaryInd, select(harvest, -species, -age, -age2), by="individual")

#adding variables to look at change across years
SummaryInd$change_shoot_diam <- SummaryInd$d_end - SummaryInd$d_start
SummaryInd$change_basal_diam <- SummaryInd$FinalBasalDiam - SummaryInd$StartBasalDiam
SummaryInd$change_shoot_area <- (3.14*((SummaryInd$d_end/2)^2)) - (3.14*((SummaryInd$d_start/2)^2))
SummaryInd$change_basal_area <- (3.14*((SummaryInd$FinalBasalDiam/2)^2)) - (3.14*((SummaryInd$StartBasalDiam/2)^2))
SummaryInd$lvs_end_total <- SummaryInd$lvs_end + SummaryInd$lvs_new
```

```{r, echo=FALSE,results='hide', message=FALSE}
#summarizing data by species, age

#leaf lifespan summary by species, age
LL_summary <- SummaryInd %>%
  filter(LL_bd>0 & LL_bd<6 & LL_birth<8 & LL_death<8) %>%
  group_by(species, age) %>%
  summarise_each(funs(mean, se, length), LL_bd, LL_death,LL_birth,new_length, lvs_end, lvs_end_total, change_shoot_diam, change_basal_diam, change_shoot_area, change_basal_area)

#LMA summary by species, age
LMA_summary <- LMA %>%
  group_by(species, age) %>%
  summarise_each(funs(mean, se, length), LMA)
names(LMA_summary)<-c("species","age","LMA_mean","LMA_se","LMA_length")

#accessory tissue summary by species, age
accessory_summary <- accessory %>%
  group_by(species, age) %>%
  summarise_each(funs(mean, se, length), PrePol_A, PrePol_S, PostPol_A, PD, Prop)

#investment summary by species, age
investment_summary <- investment %>%
  group_by(species, age) %>%
  summarise_each(funs(mean, se, length), GrowthInv, FinalWeight, FinalBasalDiamAv, TotalInvestment, RA)

#harvest summary by species, age
harvest_summary <- harvest %>%
  group_by(species, age) %>%
  summarise_each(funs(mean, se, length), height,total_leaf_weight)
#names(harvest_summary)<-c("species","age","height_mean","height_se","height_length")

#RA for each species/age combination
maxRA <- investment %>%
  group_by(species, age) %>%
  summarise_each(funs(max), RA)
names(maxRA)<-c("species","age","maxRA")

#maximum H for each species/age combination
maxH <- harvest %>%
  group_by(species, age) %>%
  summarise_each(funs(max), height)
names(maxH)<-c("species","age","maxH")

#LMA summary by species, age
LMA_summary <- LMA %>%
  group_by(species, age) %>%
  summarise_each(funs(mean, se, length), LMA)
names(LMA_summary)<-c("species","age","LMA_mean","LMA_se","LMA_length")

#wood density summary by species
wood_summary <- wood %>%
  group_by(species) %>%
  summarise_each(funs(mean, se, length), density)
names(wood_summary)<-c("species","WD_mean","WD_se","WD_length")

#leaf lifespan summary by species
LL_spp <- leafLifespan %>%
  filter(age>2) %>%
  group_by(species) %>%
  summarise_each(funs(mean, se, length), LL_bd, LL_death,LL_birth)

#LMA summary by species
LMA_spp <- LMA %>%
  filter(age>2) %>%
  group_by(species) %>%
  summarise_each(funs(mean, se, length), LMA)
  names(LMA_spp)<-c("species", "LMA_mean","LMA_se","LMA_length")

#maximum height for each species
maxH_spp <- harvest %>%
  group_by(species) %>%
  summarise_each(funs(max), height)
names(maxH_spp)<-c("species", "maxH_spp")

SummaryInd <- merge(SummaryInd,wood_summary, by=c("species"))
SummaryInd <- merge(SummaryInd,LMA_summary, by=c("species","age"))
SummaryInd <- merge(SummaryInd,maxH_spp, by=c("species"))
SummaryInd <- merge(SummaryInd,seedsize, by=c("species"))

SummaryInd$leafArea <- SummaryInd$total_leaf_weight * SummaryInd$LMA_mean

#merge various data summaries into SummarySppAge dataframe
SummarySppAge <- merge(LL_summary, LMA_summary, by=c("species","age"))
SummarySppAge <- merge(SummarySppAge, wood_summary, by=c("species"))
SummarySppAge <- merge(SummarySppAge, seedsize, by=c("species"))
SummarySppAge <- merge(SummarySppAge, maxH_spp, by=c("species"))
SummarySppAge <- merge(SummarySppAge, maxH, by=c("species","age"))
SummarySppAge <- merge(SummarySppAge, investment_summary, by=c("species","age"))
SummarySppAge <- merge(SummarySppAge, accessory_summary, by=c("species","age"))
SummarySppAge <- merge(SummarySppAge, harvest_summary, by=c("species","age"))

#merge various data summaries into SummarySpp dataframe
SummarySpp <- merge(LL_spp, LMA_spp, by=c("species"))
SummarySpp <- merge(SummarySpp, wood_summary, by=c("species"))
SummarySpp <- merge(SummarySpp, seedsize, by=c("species"))
SummarySpp <- merge(SummarySpp, select(maxH, -age), by=c("species"))

#plotting and stats
#creating lists of information for plotting symbols, colors, labels
pch.spp <- c(0,1,2,15,16,17,18,0,1,2,15,16,17,18)
col.spp <- c("red", "dark green", "blue", "purple", "orange", "light green","salmon","turquoise","grey", "black","light blue","brown","yellow","salmon")
col.age <-c("purple","pink","green","orange","blue","dark green")
pch.age <- c(1,1,16,16,16,16)
labels.spp <- c("Banksia ericifolia","Boronia ledifolia","Conospermum ericifolium","Epacris micraphylla", "Grevillea buxifolia","Grevillea speciosa","Hakea teretifolia","Hemigenia purpurea","Leucopogon esquamatus","Persoonia lanceolata", "Petrophile puchella", "Phyllota phyllicoides", "Pimelea linifolia", "Pultanaea tuberculata")
names(labels.spp) <- c("BAER","BOLE","COER","EPMI","GRBU","GRSP","HATE","HEPU","LEES","PELA","PEPU","PHPH","PILI","PUTU")
labels.age <- c("1.4","2.4","5","7","9","32")
names(labels.age) <- c("1.4","2.4","5","7","9","32")
```


#LL vs LMA using species by site means
Overall plot shows a lack of relationship when HATE included. This is because it has such a high LMA. The youngest and oldest plants have no pattern, presumably because LL data are inaccurate

```{r, echo=FALSE,results='hide', message=FALSE}

col.LMA <-c("purple", "pink", "light green", "orange","blue", "light blue","red")
labels.LMA <-c("age 1.4", "age 2.4", "age 5", "age 7", "age 9", "age 32", "HATE")
plot(LL_birth_mean ~ LMA_mean, SummarySppAge, type="n", xlab="LMA", ylab="leaf lifespan (years)", main="leaf lifespan versus LMA (all species and ages)", las=1,pch=17, log="xy")
points(LL_birth_mean ~ LMA_mean, data=subset(SummarySppAge, species!="HATE"), pch=16, cex=1.2, col=col.age[as.factor(age)])
points(LL_birth_mean ~ LMA_mean, col="red", data=subset(SummarySppAge, species=="HATE"), pch=17)
legend("bottomright",col=col.LMA, labels.LMA, pch=16, cex=1.4)

plot(LL_birth_mean ~ LMA_mean, data=subset(SummarySppAge, species!="HATE" & age>1.5), pch=16, cex=1.2, col=col.age[as.factor(age)])
mod <- lm(LL_birth_mean ~ LMA_mean, data=subset(SummarySppAge, species!="HATE" & age>1.5))
summary(mod)         
          
plot(LL_death_mean ~ LMA_mean, data=subset(SummarySppAge, species!="HATE" & age>1.5), pch=16, cex=1.2, col=col.age[as.factor(age)])
mod <- lm(LL_death_mean ~ LMA_mean, data=subset(SummarySppAge, species!="HATE" & age>1.5))
summary(mod)  


plot(LL_bd_mean ~ LMA_mean, data=subset(SummarySppAge, species!="HATE" & age>1.5), pch=16, cex=1.2, col=col.age[as.factor(age)])
legend("bottomright",col=col.age,labels.age,pch=16)
mod <- lm(LL_bd_mean ~ LMA_mean, data=subset(SummarySppAge, species!="HATE" & age>1.5))
summary(mod)  

#need log transformation to get these to plot onto axes
mod <- lm(LL_birth_mean ~ LMA_mean, SummarySppAge)
abline(mod, col="red", lty=2)
mod_no_HATE <- lm(LL_birth_mean ~ LMA_mean, data=subset(SummarySppAge, species!="HATE"))
abline(mod_no_HATE, lwd=2)

summary(mod_no_HATE)

#plot_by_age <- function(age) {
#  mod <- lm(LL_birth_mean ~ LMA_mean, data=subset(SummarySppAge,age==age&species!="HATE")
#  abline(mod, col=col.age[age], lwd=1.5)
#}

#for(n in names(labels.age)) {
#  plot_by_age(n)
#}

# Relationship between LMA, LL for 7 year old plants
# There would be a similar plot for any other age as well. As with the overall LMA analyses, HATE needs to be removed.

plot(LL_birth_mean ~ LMA_mean, data=subset(SummarySppAge,age==5), xlab="LMA", ylab="leaf lifespan (years)", main="leaf lifespan versus LMA", las=1, pch=16)
text(LL_birth_mean ~ LMA_mean, data=subset(SummarySppAge,age==5), labels=species, pos=1, offset=-0.9, cex=0.9,col="blue")
text(LL_birth_mean ~ LMA_mean, data=subset(SummarySppAge,age==5 & species=="HATE"), labels=species, pos=1, offset=-0.9, cex=0.9,col="red")
mod <- lm(LL_birth_mean ~ LMA_mean, data=subset(SummarySppAge,species!="HATE" & age==5))
summary(mod)
abline(mod)
```

#Leaf lifespan patterns
First a model showing data by age and species, omitting the youngest plants. Uses calculations for "leaf births" only. Plots of leaf lifespan by age for each of the species

Age is not significant, but some significant interactions (COER, HATE, HEPU)
And many species have sigificantly different LL from one another

```{r, echo=FALSE,results='hide', message=FALSE}
plot(LL_birth~age,SummaryInd,log="xy", xlab="age",ylab="leaf lifespan (based on leaf births)",col=col.spp[as.factor(species)])
legend("bottomright",col=col.spp, labels.spp, pch=16, cex=1)

mod <- lm(LL_birth ~ age + species, data=subset(SummaryInd,age>3 & LL_birth!="Inf"))
summary(mod)

#WHY ARE THE FOLLOWING TWO LINES OF CODE NEEDED?
leafLifespan %>% group_by(species) %>%
    summarise(mean(LL_birth))

plot_LLvAge <- function(spp) {
  plot(LL_birth ~ age, data=subset(SummaryInd,species==spp), xlab="age", ylab="leaf lifespan (leaf births)", cex.axis=.8, las=1,
     main=labels.spp[spp], xlim=c(1,35), ylim=c(0,8), log="x", pch=16)
  points(LL_birth_mean ~ age, data=subset(SummarySppAge, species==spp), cex=1.3, pch=8)
  points((LL_birth_mean+LL_birth_se) ~ age, data=subset(SummarySppAge, species==spp), cex=1.5, pch=25)
  points((LL_birth_mean-LL_birth_se) ~ age, data=subset(SummarySppAge, species==spp), cex=1.5, pch=24)
}

for(n in names(labels.spp)) {
  plot_LLvAge(n)
}

```

#LMA by age, species, without youngest plants

There is also no overall affect of age on LMA, although a few species would show an effect if analyzed independently. (Again, this model omits 1-year old plants.)

```{r, echo=FALSE, message=FALSE}
#plot(LMA_mean ~ as.factor(species), data=subset(SummarySppAge,age>3), xlab="species", ylab="LMA", cex.axis=.8, las=1)
#mod <- lm(LMA ~ age +species + age*species, LMA)
#summary(mod)

plot(LMA~age,data=subset(LMA,branch_age=="mid"),log="xy", xlab="age",ylab="LMA",col=col.spp[as.factor(species)],pch=16)
legend("bottomright",col=col.spp, labels.spp, pch=16, cex=1)
mod<- lm(LMA~age+species,data=subset(LMA,branch_age=="mid" & age>2))
summary(mod)

LMA %>% group_by(species) %>%
  summarise(mean(LMA))

plot_LMAvAge <- function(spp) {
  plot(LMA ~ age, data=subset(LMA,species==spp), xlab="age", ylab="LMA", cex.axis=.8, las=1, pch=16, log="x",
  main=labels.spp[spp])
  points(LMA_mean ~ age, data=subset(SummarySppAge, species==spp), cex=1.3, pch=8)
  points((LMA_mean+LMA_se) ~ age, data=subset(SummarySppAge, species==spp), cex=1.5, pch=25)
  points((LMA_mean-LMA_se) ~ age, data=subset(SummarySppAge, species==spp), cex=1.5, pch=24)
  }
  #I want to add a line of code that plots over the means for each age. I did this above by calling in another file, but wondering about on-the-spot calculations


mod_LMAvAge <- function(spp) {
  lm(LMA ~ age, data=subset(LMA,species==spp))
}

for(n in names(labels.spp)) {
  plot_LMAvAge(n)
  mod_LMAvAge(n)
  summary(mod_LMAvAge(n))
}
```

#models with leaf counts per age
The number of leaves on a leader is slightly affected by age however, with a decrease in leaf count along the leader with increasing age. This is what gives the perception of fewer leaves in some older plants. I'm not sure why this pattern looks stronger than leaf lifespan.

```{r, echo=FALSE,results='hide', message=FALSE}
plot(lvs_end_total~age,SummaryInd,log="xy", xlab="age",ylab="final leaf count along shoot",col=col.spp[as.factor(species)])
legend("bottomright",col=col.spp, labels.spp, pch=16, cex=1)
mod <- lm(lvs_end_total~age+species,SummaryInd)
summary(mod)


plot_lfcountvAge <- function(spp) {
  plot(lvs_end_total ~ age, data=subset(SummaryInd,species==spp), xlab="age", ylab="leaf count along shoot", cex.axis=.8, las=1, pch=16, log="x",
  main=labels.spp[spp])
  points(lvs_end_total_mean ~ age, data=subset(SummarySppAge, species==spp), cex=1.3, pch=8)
  points((lvs_end_total_mean+lvs_end_se) ~ age, data=subset(SummarySppAge, species==spp), cex=1.5, pch=25)
  points((lvs_end_total_mean-lvs_end_se) ~ age, data=subset(SummarySppAge, species==spp), cex=1.5, pch=24)
}

mod_lfcountvAge <- function(spp) {
  lm(lvs_end ~ age, data=subset(SummaryInd,age>2.4 & species==spp))
}

for(n in names(labels.spp)) {
  plot_lfcountvAge(n)
  mod_lfcountvAge(n)
  summary(mod_lfcountvAge(n))
}
```

#models with shoot extenstion by age
These models show that for some species, shoot extension decreases enormously in the older plants. This effect is larger than with number of leaves.

```{r, echo=FALSE,results='hide', message=FALSE}

plot_newlengthvAge <- function(spp) {
  plot(new_length ~ age, data=subset(SummaryInd,species==spp), xlab="age", ylab="leader shoot extention", cex.axis=.8, las=1, pch=16, log="x",
  main=labels.spp[spp])
  points(new_length_mean ~ age, data=subset(SummarySppAge, species==spp), cex=1.3, pch=8)
  points((new_length_mean+new_length_se) ~ age, data=subset(SummarySppAge, species==spp), cex=1.5, pch=25)
  points((new_length_mean-new_length_se) ~ age, data=subset(SummarySppAge, species==spp), cex=1.5, pch=24)
}

mod_newlengthvAge <- function(spp) {
  lm(new_length ~ age, data=subset(SummaryInd,age>2.4 & species==spp))
}

for(n in names(labels.spp)) {
  plot_newlengthvAge(n)
  mod_newlengthvAge(n)
  summary(mod_newlengthvAge(n))
}
```

# Plotting final leaf number on the leader by diameter increase of the entire plant (basal diameter) and the leader (shoot diameter).

Both show a strong correlation and species effect as expected. For the model with basal diameter there is a strong age effect, but not for shoot diameter. This is presumably because a shoot of a given species should always deploy the same number of leaves for the same diameter increase. In contrast, the whole plant will have many differing shoot numbers with age, so differing effects of a single shoot's increased diameter. Strangely, the model with basal diameter shows a stronger effect between diameter increase and leaf number.

```{r, echo=FALSE,results='hide', message=FALSE}
plot(change_basal_diam ~ lvs_end_total, SummaryInd, log="xy", col=col.age[as.factor(age)], pch=16, xlab="leaf number on leader", ylab="change in basal diameter")
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod <- lm(log(lvs_end_total) ~ log(change_basal_diam+1) + species +age, SummaryInd)
summary(mod)

plot(change_shoot_diam ~ lvs_end_total, SummaryInd, log="xy", col=col.age[as.factor(age)], pch=16, xlab="leaf number on leader", ylab="change in diameter of leader")
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod <- lm(log(lvs_end_total) ~ log(change_shoot_diam+10) + species +age, data= subset(SummaryInd, !is.na(change_shoot_diam)))
summary(mod)
```

#other models looking at how the relationship between leaf weight (or area) and total plant weight shifts with age
this should be another way to get at the decreasing "leafiness" of plants with age

```{r, echo=FALSE,results='hide', message=FALSE}
plot(total_leaf_weight~FinalWeight,SummaryInd, log="xy",col=col.age[as.factor(age)], pch=16, cex=0.8)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod <-lm(FinalWeight~total_leaf_weight+age+species,SummaryInd)
summary(mod)

plot_LeafWeight <- function(spp) {
  plot(total_leaf_weight~FinalWeight,data=subset(SummaryInd,species==spp), xlab="total weight (mg)", ylab ="leaf weight (mg)", log="xy",col=col.age[as.factor(age)], pch=16,     cex=0.8,main=labels.spp[spp])
  legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
  mod <-lm(FinalWeight~total_leaf_weight+age,data=subset(SummaryInd,species==spp))
  abline(mod)
  summary(mod)
}

for(n in names(labels.spp)) {
  plot_LeafWeight(n)
  
#plot looking at leaf area versus plant weight
#USE THIS PLOT IN LAB MEETING - CLEARLY SHOWS DECLINE IN INTERCEPT WITH AGE  
plot(leafArea~FinalWeight,SummaryInd, log="xy",col=col.age[as.factor(age)], pch=16, cex=0.8)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod <-lm(FinalWeight~leafArea+age+species,SummaryInd)
summary(mod)

plot_LeafArea <- function(spp) {
  plot(leafArea~FinalWeight,data=subset(SummaryInd,species==spp), xlab="total weight (mg)", ylab ="leaf weight (mg)", log="xy",col=col.age[as.factor(age)], pch=16,     cex=0.8,main=labels.spp[spp])
  legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
  mod <-lm(FinalWeight~leafArea+age,data=subset(SummaryInd,species==spp))
  abline(mod)
  summary(mod)
}

for(n in names(labels.spp)) {
  plot_LeafArea(n)
} 


#plots looking at shoot extension versus plant size
plot(new_length~FinalWeight,SummaryInd, log="xy",col=col.age[as.factor(age)], pch=16, cex=0.8)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod <-lm(FinalWeight~new_length+age+species,SummaryInd)
summary(mod)

plot_LeaderExtension <- function(spp) {
  plot(new_length~FinalWeight,data=subset(SummaryInd,species==spp), xlab="total weight (mg)", ylab ="leaf weight (mg)", log="xy",col=col.age[as.factor(age)], pch=16,     cex=0.8,main=labels.spp[spp])
  legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
  mod <-lm(FinalWeight~new_length+age,data=subset(SummaryInd,species==spp))
  abline(mod)
  summary(mod)
}

for(n in names(labels.spp)) {
  plot_LeaderExtension(n)
} 
```
  
#many plots regressing variables against one another
```{r, echo=FALSE,results='hide', message=FALSE}
plot(change_shoot_area~new_length,SummaryInd, log="xy",col=col.age[as.factor(age)], pch=16, cex=.8, xlab="shoot extension (mm)", ylab="increased shoot cross sectional area")
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod <- lm(change_shoot_area~new_length +age,data=subset(SummaryInd,change_shoot_area<1000000))
summary(mod)

plot(lvs_end_total~lvs_start,SummaryInd, log="xy",col=col.age[as.factor(age)], pch=16, cex=.8, xlab="starting leaf count", ylab="ending leaf count")

legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod <- lm(lvs_start~lvs_end_total+age +age*lvs_end_total, SummaryInd)
summary(mod)
#IS THERE AN EASY WAY TO ADD A 1:1 LINE TO THIS PLOT?

plot(LL_birth_mean~LMA_mean,data=subset(SummarySppAge,species!="HATE"),col=col.age[as.factor(age)], pch=16, cex=.8, log="xy",xlab="LMA", ylab="leaf lifespan (calculated from leaf births")
points(LL_birth_mean~LMA_mean,data=subset(SummarySppAge,species=="HATE"),col="red", pch=19, cex=.8)
```

#beginning with a large number of regressions to look for general pattern across variables
A few stand out, noticeably that growth at the shoot level and whole plant level are well-correlated, indicating that a plant, even old ones, are distributing their available energy evenly to all shoots
Also, max height and LMA (at a species*age level) are well correlated, There is obviously a strong effect of age, since older plants are taller.

```{r, echo=FALSE,results='hide', message=FALSE}
pairs(SummarySppAge[c("RA_mean", "GrowthInv_mean", "Prop_mean", "LL_birth_mean","LL_death_mean","new_length_mean", "change_shoot_area_mean","change_basal_area_mean","LMA_mean","WD_mean","seed_size","maxH")], log="xy")

plot(maxH ~ LMA_mean,SummarySppAge,log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(LMA_mean~maxH+age,data=subset(SummarySppAge,species!="PEPU"))
summary(mod)

plot(maxH ~ LMA_mean,SummarySppAge,log="xy",col=col.spp[as.factor(species)],pch=16,cex=.7)
legend("bottomright",col=col.spp, labels.spp, pch=16, cex=1)

plot(GrowthInv_mean ~ LMA_mean,SummarySppAge,log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(LMA_mean~GrowthInv+age,data=subset(SummarySppAge,species!="PEPU"))
summary(mod)
```

#Plots of interest to Anais' analyses
The following plots look at the correlation between growth (absolute growth in this case) versus LMA, wood density, maxH (at that age), and seed size.

They show,
for LMA: slight positive correlation for youngest plants, no correlation for intermediate plants, strong positive correlation for adult plants
for wood density: no correlation for yougest plants, intermediate plants, but strong negative correlation for adult plants
```{r, echo=FALSE,results='hide', message=FALSE}
plot(GrowthInv_mean ~ LMA_mean,data=subset(SummarySppAge,age==1.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(LMA_mean~GrowthInv_mean+age,data=subset(SummarySppAge,age==1.4))
summary(mod)

plot(GrowthInv_mean ~ LMA_mean,data=subset(SummarySppAge,age==2.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(LMA_mean~GrowthInv_mean+age,data=subset(SummarySppAge,age==2.4))
summary(mod)

plot(GrowthInv_mean ~ LMA_mean,data=subset(SummarySppAge,age>3),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(LMA_mean~GrowthInv_mean+age,data=subset(SummarySppAge,age>3))
summary(mod)


plot(GrowthInv_mean ~ WD_mean,data=subset(SummarySppAge,age==1.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(WD_mean~GrowthInv_mean+age,data=subset(SummarySppAge,age==1.4))
summary(mod)

plot(GrowthInv_mean ~ WD_mean,data=subset(SummarySppAge,age==2.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(WD_mean~GrowthInv_mean+age,data=subset(SummarySppAge,age==2.4))
summary(mod)

plot(GrowthInv_mean ~ WD_mean,data=subset(SummarySppAge,age>3),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(WD_mean~GrowthInv_mean+age,data=subset(SummarySppAge,age>3))
summary(mod)



plot(GrowthInv_mean ~ seed_size,data=subset(SummarySppAge,age==1.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(seed_size~GrowthInv_mean+age,data=subset(SummarySppAge,age==1.4))
summary(mod)

plot(GrowthInv_mean ~ seed_size,data=subset(SummarySppAge,age==2.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(seed_size~GrowthInv_mean+age,data=subset(SummarySppAge,age==2.4))
summary(mod)

plot(GrowthInv_mean ~ seed_size,data=subset(SummarySppAge,age>3),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(seed_size~GrowthInv_mean+age,data=subset(SummarySppAge,age>3))
summary(mod)



plot(GrowthInv_mean ~ maxH,data=subset(SummarySppAge,age==1.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(maxH~GrowthInv_mean,data=subset(SummarySppAge,age==1.4))
summary(mod)

plot(GrowthInv_mean ~ maxH,data=subset(SummarySppAge,age==2.4),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(maxH~GrowthInv_mean,data=subset(SummarySppAge,age==2.4))
summary(mod)

plot(GrowthInv_mean ~ maxH,data=subset(SummarySppAge,age>3),log="xy",col=col.age[as.factor(age)],pch=16,cex=.7)
legend("bottomright",col=col.age, labels.age, pch=16, cex=1)
mod<-lm(maxH~GrowthInv_mean+age,data=subset(SummarySppAge,age>3))
summary(mod)
```

#Plots with RA by age 
Will include a couple of the obviously different species in lab meeting

```{r, echo=FALSE,results='hide', message=FALSE}
plot_RAbyAge <- function(spp) {
  plot(RA~age, data=subset(SummaryInd,species==spp), xlab="age (years)",ylab="reproductive allocation (%)", log="x", main=labels.spp[spp],xlim=c(1,35),ylim=c(0,1))
  points(RA_mean~age, data=subset(SummarySppAge, species==spp),pch=16,cex=1.4)
}


for(n in names(labels.spp)) {
  plot_RAbyAge(n)
} 
```


#Plots of Accessory costs by age
```{r, echo=FALSE,results='hide', message=FALSE}

plot_PropagulebyAge <- function(spp) {
  plot(Prop~age, data=subset(SummaryInd,species==spp), xlab="age",ylab="investment on propagule", log="x", main=labels.spp[spp])
  points(Prop_mean~age, data=subset(SummarySppAge, species==spp),pch=16,cex=1.2)
}


for(n in names(labels.spp)) {
  plot_PropagulebyAge(n)
} 

```