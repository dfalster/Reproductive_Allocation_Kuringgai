```{r, echo=FALSE,results='hide', message=FALSE,warning=FALSE}
library(remake)
create_bindings()

source("scripts/summary_dataframes.R")
source("scripts/functions.R")
```

##Summary
    1. Species show a marked decline in leaf investment with age and a limited decline in stem investment with age
    2. Some species have a very narrow height range where they all become reproductively mature, while others are more spread out  
        * canopy species - those where height matters - have a clearer transition with height
    4. Species with higher leaf lifespan have greater shoot leaf area  
        * there is a much smaller effect at the whole plant level  




###1. Vegetative investment by size curves by species  
* Individuals within a site show a remarkably linear increase in total vegetative investment with increasing size  
* However, across species, there is a distinct decrease in the intercept of the line as plants age, turning into a scatter plot at the oldest sites
* This is because of a rapid decrease in investment in leaves with age  
* For most species there is only a decline in stem investment at the oldest sites  

```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "GrowthInv"
xvar <- "prop_maxH"

data <- subset(SummaryInd)
data <- split(data, data$species)
lmfits <- lapply(data, function(x) lm((log(x[[yvar]])) ~  ((x[[xvar]]))))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="y",xlab="",ylab="",cex=1.4,
                    main=spp,col=col.mature[as.factor(data[[spp]]$mature)])
}

mtext("Vegetative investment", 2, outer=TRUE,cex=1.2)
mtext("proportion maximum H", 1, outer=TRUE,cex=1.2)
legend("topleft",legend=names(labels.mature),col=col.mature,pch=16, cex=1.1,bty="n")
```


```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "growth_leaf"
xvar <- "total_weight"

data <- subset(SummaryInd)
data <- split(data, data$species)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="xy",cex=1.4, xlab="",ylab="",
                    main=spp,col=col.age[as.factor(data[[spp]]$age)])
}

mtext("Investment in leaves (mg)", 2, outer=TRUE,cex=1.2)
mtext("Total plant weight (mg)", 1, outer=TRUE,cex=1.2)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=1.1,bty="n")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "growth_stem"
xvar <- "total_weight"

data <- subset(SummaryInd)
data <- split(data, data$species)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="xy",cex=1.4, xlab="",ylab="",
                    main=spp,col=col.age[as.factor(data[[spp]]$age)])
}

mtext("Investment in stems (mg)", 2, outer=TRUE,cex=1.2)
mtext("Total plant weight (mg)", 1, outer=TRUE,cex=1.2)
legend("bottomright",legend=names(labels.age),col=col.age,pch=16, cex=1.1,bty="n")
```

####Growth along shoot vs. stem  
* For many species, increased relative growth along leaders (shoots) vs. stems as plants age  
* far more dark purple dots below the 1:1 line

```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "growth_stem_diam"
xvar <- "growth_shoot_diam"

data <- subset(SummaryInd)
data <- split(data, data$species)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="xy",xlab="",ylab="",cex=1.4,
                    main=spp,col=col.age[as.factor(data[[spp]]$age)])
  abline(0,1)
}

mtext("increase in stem diameter (mm)", 2, outer=TRUE,cex=1.2)
mtext("increase in shoot diameter (mm)", 1, outer=TRUE,cex=1.2)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=0.9,bty="n")
```

####Plots of increase in whole plant versus shoot leaf area  
* Very different, patterns across species

```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "leaf_area_growth"
xvar <- "shoot_leaf_area_growth"

data <- subset(SummaryInd)
data <- split(data, data$species)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="xy",xlab="",ylab="",cex=1.4,
                    main=spp,col=col.age[as.factor(data[[spp]]$age)])
  abline(0,1)
}

mtext("increase in whole plant leaf area", 2, outer=TRUE,cex=1.2)
mtext("increase in shoot leaf area", 1, outer=TRUE,cex=1.2)
```

####leaf lifespan versus leaf area  
* at the shoot level, there is a within species and across all data point correlation  
    * not surprising, because this is how leaf lifespan is calculated  
    * however, it is interesting that there is an age trajectory for many species  
* for whole plant leaf area, there is only a within species shift in PELA - this species shows increasing leaf lifespan with age (except at old age) as well as increased total leaf area  
    * interesting in that this is the species reproducing last and might well have additional mechanisms for increasing leaf area during its long juvenile period  
    
```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=14, fig.height=7}
par(mfrow=c(1,2), cex=1, omi=c(0.2,0.3,0.3,0.3), mai=c(1.1,1,0.3,0.3)) 
plot(LL_death~shoot_leaf_area,data=subset(SummaryInd,LL_death<6),log="x",pch=16,col=col.spp[as.factor(species)])
mod <- lm(log(shoot_leaf_area)~LL_death,data=subset(SummaryInd,LL_death<6))
words.top.right.logx(mod)

plot(LL_death~leaf_area,data=subset(SummaryInd,LL_death<6),log="x",pch=16,col=col.spp[as.factor(species)])
mod <- lm(log(leaf_area)~LL_death,data=subset(SummaryInd,LL_death<6))
words.top.right.logx(mod)
```

***leaf lifespan vs. shoot leaf area***
```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "LL_death"
xvar <- "shoot_leaf_area"

data <- subset(SummaryInd, LL_death<6)
data <- split(data, data$species)

lmfits <- lapply(data, function(x) lm(((x[[yvar]])) ~  (log(x[[xvar]]))))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="x",xlab="",ylab="",cex=1.4,
                    main=spp,col=col.age[as.factor(data[[spp]]$age)])
}

mtext("ll death", 2, outer=TRUE,cex=1.2)
mtext("shoot leaf area", 1, outer=TRUE,cex=1.2)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=1.1,bty="n")
```

***leaf lifespan vs. whole plant leaf area***  
*the regression results below exclude young individuals  
```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "LL_death"
xvar <- "leaf_area"

data <- subset(SummaryInd, LL_death<6)
data <- split(data, data$species)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="x",xlab="",ylab="",cex=1.4,
                    main=spp,col=col.age[as.factor(data[[spp]]$age)])
}

mtext("ll death", 2, outer=TRUE,cex=1.2)
mtext("leaf area", 1, outer=TRUE,cex=1.2)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=1.1,bty="n")

yvar <- "LL_death"
xvar <- "leaf_area"

data <- subset(SummaryInd, LL_death<6&age>2)
data <- split(data, data$species)

lmfits <- lapply(data, function(x) lm(((x[[yvar]])) ~  (log(x[[xvar]]))))
results <- summarise_all_fits(lmfits)

results$r.squared <- round(results$r.squared,digits=3)
results$p.value <- round(results$p.value,digits=3)
results$a <- round(results$a,digits=2)
results$b <- round(results$b,digits=2)

results
```

***growth stem diam vs. prop maxH***
```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=14, fig.height=7}
par(mfrow=c(1,2), cex=1, omi=c(0.2,0.3,0.3,0.3), mai=c(1.1,1,0.3,0.3)) 
plot(growth_stem_diam~prop_maxH,SummaryInd,log="y",pch=16,col=col.spp[as.factor(species)])
```

```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "growth_stem_diam"
xvar <- "prop_maxH"

data <- subset(SummaryInd)
data <- split(data, data$species)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="y",xlab="",ylab="",cex=1.4,
                    main=spp,col=col.age[as.factor(data[[spp]]$age)])
}

mtext("growth_stem_diam", 2, outer=TRUE,cex=1.2)
mtext("prop_maxH", 1, outer=TRUE,cex=1.2)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=1.1,bty="n")
```

***growth leaf area vs. prop maxH***
```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=14, fig.height=7}
par(mfrow=c(1,2), cex=1, omi=c(0.2,0.3,0.3,0.3), mai=c(1.1,1,0.3,0.3)) 
plot(leaf_area_growth~prop_maxH,SummaryInd,log="y",pch=16,col=col.spp[as.factor(species)])
```

```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "leaf_area_growth"
xvar <- "prop_maxH"

data <- subset(SummaryInd)
data <- split(data, data$species)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="y",xlab="",ylab="",cex=1.4,
                    main=spp,col=col.age[as.factor(data[[spp]]$age)])
}

mtext("increase in leaf area", 2, outer=TRUE,cex=1.2)
mtext("prop_maxH", 1, outer=TRUE,cex=1.2)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=1.1,bty="n")
```


```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "total_weight"
xvar <- "prop_maxH"

data <- subset(SummaryInd)
data <- split(data, data$species)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="y",xlab="",ylab="",cex=1.4,
                    main=spp,col=col.age[as.factor(data[[spp]]$age)])
}

mtext("total size", 2, outer=TRUE,cex=1.2)
mtext("prop_maxH", 1, outer=TRUE,cex=1.2)
legend("topleft",legend=names(labels.age),col=col.age,pch=16, cex=1.1,bty="n")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=28, fig.height=28}
par(mfrow=c(4,4), cex=1, omi=c(.7,.7,.1,.1), mai=c(.7,.9,.4,0.2)) 
yvar <- "total_weight"
xvar <- "prop_maxH"

data <- subset(SummaryInd)
data <- split(data, data$species)

for(spp in names(data)) {
  plot_yvar_vs_xvar(data[[spp]], yvar, xvar,log="y",xlab="",ylab="",cex=1.4,
                    main=spp,col=col.mature[as.factor(data[[spp]]$mature)])
}

mtext("total size", 2, outer=TRUE,cex=1.2)
mtext("prop_maxH", 1, outer=TRUE,cex=1.2)
legend("bottomright",legend=names(labels.mature),col=col.mature,pch=16, cex=1.1,bty="n")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE, fig.width=14, fig.height=7}
par(mfrow=c(1,2), cex=1, omi=c(0.2,0.3,0.3,0.3), mai=c(1.1,1,0.3,0.3)) 

plot(wood_density~leaf_area_growth,SummaryInd,log="y",pch=16,col=col.age[as.factor(age)])
mod <- lm(log(leaf_area_growth)~age*wood_density,SummaryInd)
summary(mod)
```